[
  {
    "discussion_id": "1450664998",
    "pr_number": 16289,
    "pr_file": "Library/Homebrew/cmd/update.sh",
    "created_at": "2024-01-12T16:18:49+00:00",
    "commented_code": "# the refspec ensures that the default upstream branch gets updated\n     (\n       UPSTREAM_REPOSITORY_URL=\"$(git config remote.origin.url)\"\n+      unset UPSTREAM_REPOSITORY\n+      unset UPSTREAM_REPOSITORY_TOKEN\n \n       # HOMEBREW_UPDATE_FORCE and HOMEBREW_UPDATE_AUTO aren't modified here so ignore subshell warning.\n       # shellcheck disable=SC2030\n       if [[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]\n       then\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+      elif [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@]+)(:([^@]+))?@)?github.com/(.*)$ ]]",
    "repo_full_name": "Homebrew/brew",
    "discussion_comments": [
      {
        "comment_id": "1450664998",
        "repo_full_name": "Homebrew/brew",
        "pr_number": 16289,
        "pr_file": "Library/Homebrew/cmd/update.sh",
        "discussion_id": "1450664998",
        "commented_code": "@@ -637,13 +628,35 @@ EOS\n     # the refspec ensures that the default upstream branch gets updated\n     (\n       UPSTREAM_REPOSITORY_URL=\"$(git config remote.origin.url)\"\n+      unset UPSTREAM_REPOSITORY\n+      unset UPSTREAM_REPOSITORY_TOKEN\n \n       # HOMEBREW_UPDATE_FORCE and HOMEBREW_UPDATE_AUTO aren't modified here so ignore subshell warning.\n       # shellcheck disable=SC2030\n       if [[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]\n       then\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+      elif [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@]+)(:([^@]+))?@)?github.com/(.*)$ ]]",
        "comment_created_at": "2024-01-12T16:18:49+00:00",
        "comment_author": "Bo98",
        "comment_body": "```suggestion\r\n      elif [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@/?#]+)(:([^@/?#]+))?@)github\\.com/(.*)$ ]]\r\n```\r\n\r\n- Group 1 `?` seemed unnecessary as that just reduces it down to the earlier `if` condition.\r\n- `/` and similar URL component separators should not be matched in the username password as if they appear then the `github.com` part moves from matching the host component to matching the path component of the URL, which we don't want. Probably could be stricter but this is  good enough\r\n- Escape `.` so we're only actually matching GitHub",
        "pr_file_module": null
      },
      {
        "comment_id": "1450716050",
        "repo_full_name": "Homebrew/brew",
        "pr_number": 16289,
        "pr_file": "Library/Homebrew/cmd/update.sh",
        "discussion_id": "1450664998",
        "commented_code": "@@ -637,13 +628,35 @@ EOS\n     # the refspec ensures that the default upstream branch gets updated\n     (\n       UPSTREAM_REPOSITORY_URL=\"$(git config remote.origin.url)\"\n+      unset UPSTREAM_REPOSITORY\n+      unset UPSTREAM_REPOSITORY_TOKEN\n \n       # HOMEBREW_UPDATE_FORCE and HOMEBREW_UPDATE_AUTO aren't modified here so ignore subshell warning.\n       # shellcheck disable=SC2030\n       if [[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]\n       then\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+      elif [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@]+)(:([^@]+))?@)?github.com/(.*)$ ]]",
        "comment_created_at": "2024-01-12T17:06:51+00:00",
        "comment_author": "cho-m",
        "comment_body": "> * Group 1 `?` seemed unnecessary as that just reduces it down to the earlier `if` condition.\r\n\r\nIs Group 1 itself even necessary? `${BASH_REMATCH[1]}` isn't used so perhaps remove group and shift numbers down.",
        "pr_file_module": null
      },
      {
        "comment_id": "1450788067",
        "repo_full_name": "Homebrew/brew",
        "pr_number": 16289,
        "pr_file": "Library/Homebrew/cmd/update.sh",
        "discussion_id": "1450664998",
        "commented_code": "@@ -637,13 +628,35 @@ EOS\n     # the refspec ensures that the default upstream branch gets updated\n     (\n       UPSTREAM_REPOSITORY_URL=\"$(git config remote.origin.url)\"\n+      unset UPSTREAM_REPOSITORY\n+      unset UPSTREAM_REPOSITORY_TOKEN\n \n       # HOMEBREW_UPDATE_FORCE and HOMEBREW_UPDATE_AUTO aren't modified here so ignore subshell warning.\n       # shellcheck disable=SC2030\n       if [[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]\n       then\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+      elif [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@]+)(:([^@]+))?@)?github.com/(.*)$ ]]",
        "comment_created_at": "2024-01-12T18:20:16+00:00",
        "comment_author": "Bo98",
        "comment_body": "Indeed it seems we can remove that grouping",
        "pr_file_module": null
      },
      {
        "comment_id": "1451692323",
        "repo_full_name": "Homebrew/brew",
        "pr_number": 16289,
        "pr_file": "Library/Homebrew/cmd/update.sh",
        "discussion_id": "1450664998",
        "commented_code": "@@ -637,13 +628,35 @@ EOS\n     # the refspec ensures that the default upstream branch gets updated\n     (\n       UPSTREAM_REPOSITORY_URL=\"$(git config remote.origin.url)\"\n+      unset UPSTREAM_REPOSITORY\n+      unset UPSTREAM_REPOSITORY_TOKEN\n \n       # HOMEBREW_UPDATE_FORCE and HOMEBREW_UPDATE_AUTO aren't modified here so ignore subshell warning.\n       # shellcheck disable=SC2030\n       if [[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]\n       then\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+      elif [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@]+)(:([^@]+))?@)?github.com/(.*)$ ]]",
        "comment_created_at": "2024-01-14T09:23:41+00:00",
        "comment_author": "sazriel26",
        "comment_body": "Thank you all for your feedbacks and suggestions!\r\n\r\nIndeed, based on https://en.wikipedia.org/wiki/URL#Syntax, what about to rewrite the parsing in the `elif` to suit to:\r\n`https://[userinfo]@github.com/[path]`\r\n_(`${BASH_REMATCH[1]}` will be `userinfo` part and `${BASH_REMATH[2]}` will be the `path`)_\r\n\r\nand then to look inside how it is formatted (`user[:password]`) and apply onto some protections like avoiding any characters that are not expected (would add `$` in the list to avoid also shell expansion at evaluation / runtime...)\r\n\r\nFrom my experiences, the GIT API Key looks to match `^[[:alnum:]_]+$`, maybe could be another interesting point to simplify the parsing above?",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "1448478941",
    "pr_number": 16289,
    "pr_file": "Library/Homebrew/cmd/update.sh",
    "created_at": "2024-01-11T08:32:55+00:00",
    "commented_code": "# HOMEBREW_UPDATE_FORCE and HOMEBREW_UPDATE_AUTO aren't modified here so ignore subshell warning.\n       # shellcheck disable=SC2030\n-      if [[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]\n+      if [[ \"${UPSTREAM_REPOSITORY_URL}\" = \"https://github.com/\"* ]] ||\n+         [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@]+)(:([^@]+))?@)?github.com/(.*)$ ]]\n       then\n-        UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n-        UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+        if [[ -n \"${BASH_REMATCH[5]}\" ]]\n+        then\n+          UPSTREAM_REPOSITORY=\"${BASH_REMATCH[5]%.git}\"\n+        else\n+          UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n+          UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+        fi\n+        # HOMEBREW_GITHUB_API_TOKEN is optionally defined in the user environment.\n+        # Global token HOMEBREW_GITHUB_API_TOKEN supersedes local defined one\n+        # shellcheck disable=SC2153\n+        if [[ -n \"${HOMEBREW_GITHUB_API_TOKEN}\" ]]",
    "repo_full_name": "Homebrew/brew",
    "discussion_comments": [
      {
        "comment_id": "1448478941",
        "repo_full_name": "Homebrew/brew",
        "pr_number": 16289,
        "pr_file": "Library/Homebrew/cmd/update.sh",
        "discussion_id": "1448478941",
        "commented_code": "@@ -640,10 +631,31 @@ EOS\n \n       # HOMEBREW_UPDATE_FORCE and HOMEBREW_UPDATE_AUTO aren't modified here so ignore subshell warning.\n       # shellcheck disable=SC2030\n-      if [[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]\n+      if [[ \"${UPSTREAM_REPOSITORY_URL}\" = \"https://github.com/\"* ]] ||\n+         [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@]+)(:([^@]+))?@)?github.com/(.*)$ ]]\n       then\n-        UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n-        UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+        if [[ -n \"${BASH_REMATCH[5]}\" ]]\n+        then\n+          UPSTREAM_REPOSITORY=\"${BASH_REMATCH[5]%.git}\"\n+        else\n+          UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n+          UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+        fi\n+        # HOMEBREW_GITHUB_API_TOKEN is optionally defined in the user environment.\n+        # Global token HOMEBREW_GITHUB_API_TOKEN supersedes local defined one\n+        # shellcheck disable=SC2153\n+        if [[ -n \"${HOMEBREW_GITHUB_API_TOKEN}\" ]]",
        "comment_created_at": "2024-01-11T08:32:55+00:00",
        "comment_author": "MikeMcQuaid",
        "comment_body": "```suggestion\r\n        if [[ \"${UPSTREAM_REPOSITORY_URL}\" = \"https://github.com/\"* ]] && \r\n           [[ -n \"${HOMEBREW_GITHUB_API_TOKEN}\" ]]\r\n```\r\n\r\nor similar as otherwise `HOMEBREW_GITHUB_API_TOKEN` being set at all may limit this.\r\n\r\nIt may be desirable to have a single `[[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]` check which sets a variable e.g. `UPSTREAM_REPOSITORY_GITHUB_GLOB` or something which you can then check in these multiple places later.",
        "pr_file_module": null
      },
      {
        "comment_id": "1448603661",
        "repo_full_name": "Homebrew/brew",
        "pr_number": 16289,
        "pr_file": "Library/Homebrew/cmd/update.sh",
        "discussion_id": "1448478941",
        "commented_code": "@@ -640,10 +631,31 @@ EOS\n \n       # HOMEBREW_UPDATE_FORCE and HOMEBREW_UPDATE_AUTO aren't modified here so ignore subshell warning.\n       # shellcheck disable=SC2030\n-      if [[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]\n+      if [[ \"${UPSTREAM_REPOSITORY_URL}\" = \"https://github.com/\"* ]] ||\n+         [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@]+)(:([^@]+))?@)?github.com/(.*)$ ]]\n       then\n-        UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n-        UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+        if [[ -n \"${BASH_REMATCH[5]}\" ]]\n+        then\n+          UPSTREAM_REPOSITORY=\"${BASH_REMATCH[5]%.git}\"\n+        else\n+          UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n+          UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+        fi\n+        # HOMEBREW_GITHUB_API_TOKEN is optionally defined in the user environment.\n+        # Global token HOMEBREW_GITHUB_API_TOKEN supersedes local defined one\n+        # shellcheck disable=SC2153\n+        if [[ -n \"${HOMEBREW_GITHUB_API_TOKEN}\" ]]",
        "comment_created_at": "2024-01-11T10:07:47+00:00",
        "comment_author": "sazriel26",
        "comment_body": "Should be taken in charge by latest update of the code.",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "1448615646",
    "pr_number": 16289,
    "pr_file": "Library/Homebrew/cmd/update.sh",
    "created_at": "2024-01-11T10:17:37+00:00",
    "commented_code": "# the refspec ensures that the default upstream branch gets updated\n     (\n       UPSTREAM_REPOSITORY_URL=\"$(git config remote.origin.url)\"\n+      unset UPSTREAM_REPOSITORY\n+      unset UPSTREAM_REPOSITORY_TOKEN\n \n       # HOMEBREW_UPDATE_FORCE and HOMEBREW_UPDATE_AUTO aren't modified here so ignore subshell warning.\n       # shellcheck disable=SC2030\n-      if [[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]\n+\n+      if [[ \"${UPSTREAM_REPOSITORY_URL}\" = \"https://github.com/\"* ]]\n       then\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+      elif [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@]+)(:([^@]+))?@)?github.com/(.*)$ ]]\n+      then\n+        UPSTREAM_REPOSITORY=\"${BASH_REMATCH[5]%.git}\"\n+        UPSTREAM_REPOSITORY_TOKEN=\"${BASH_REMATCH[4]:-${BASH_REMATCH[2]}}\"\n+      fi\n+\n+      if [[ -n \"${UPSTREAM_REPOSITORY}\" ]]\n+      then\n+        # HOMEBREW_GITHUB_API_TOKEN is optionally defined in the user environment.\n+        # Global token HOMEBREW_GITHUB_API_TOKEN supersedes local defined one\n+        # shellcheck disable=SC2153\n+        if [[ -n \"${HOMEBREW_GITHUB_API_TOKEN}\" ]]\n+        then\n+          CURL_GITHUB_API_ARGS=(\"--header\" \"Authorization: token ${HOMEBREW_GITHUB_API_TOKEN}\")\n+        elif [[ -n \"${UPSTREAM_REPOSITORY_TOKEN}\" ]]\n+        then\n+          CURL_GITHUB_API_ARGS=(\"--header\" \"Authorization: token ${UPSTREAM_REPOSITORY_TOKEN}\")",
    "repo_full_name": "Homebrew/brew",
    "discussion_comments": [
      {
        "comment_id": "1448615646",
        "repo_full_name": "Homebrew/brew",
        "pr_number": 16289,
        "pr_file": "Library/Homebrew/cmd/update.sh",
        "discussion_id": "1448615646",
        "commented_code": "@@ -637,13 +628,36 @@ EOS\n     # the refspec ensures that the default upstream branch gets updated\n     (\n       UPSTREAM_REPOSITORY_URL=\"$(git config remote.origin.url)\"\n+      unset UPSTREAM_REPOSITORY\n+      unset UPSTREAM_REPOSITORY_TOKEN\n \n       # HOMEBREW_UPDATE_FORCE and HOMEBREW_UPDATE_AUTO aren't modified here so ignore subshell warning.\n       # shellcheck disable=SC2030\n-      if [[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]\n+\n+      if [[ \"${UPSTREAM_REPOSITORY_URL}\" = \"https://github.com/\"* ]]\n       then\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+      elif [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@]+)(:([^@]+))?@)?github.com/(.*)$ ]]\n+      then\n+        UPSTREAM_REPOSITORY=\"${BASH_REMATCH[5]%.git}\"\n+        UPSTREAM_REPOSITORY_TOKEN=\"${BASH_REMATCH[4]:-${BASH_REMATCH[2]}}\"\n+      fi\n+\n+      if [[ -n \"${UPSTREAM_REPOSITORY}\" ]]\n+      then\n+        # HOMEBREW_GITHUB_API_TOKEN is optionally defined in the user environment.\n+        # Global token HOMEBREW_GITHUB_API_TOKEN supersedes local defined one\n+        # shellcheck disable=SC2153\n+        if [[ -n \"${HOMEBREW_GITHUB_API_TOKEN}\" ]]\n+        then\n+          CURL_GITHUB_API_ARGS=(\"--header\" \"Authorization: token ${HOMEBREW_GITHUB_API_TOKEN}\")\n+        elif [[ -n \"${UPSTREAM_REPOSITORY_TOKEN}\" ]]\n+        then\n+          CURL_GITHUB_API_ARGS=(\"--header\" \"Authorization: token ${UPSTREAM_REPOSITORY_TOKEN}\")",
        "comment_created_at": "2024-01-11T10:17:37+00:00",
        "comment_author": "MikeMcQuaid",
        "comment_body": "```suggestion\r\n        if [[ -n \"${UPSTREAM_REPOSITORY_TOKEN}\" ]]\r\n        then\r\n          CURL_GITHUB_API_ARGS=(\"--header\" \"Authorization: token ${UPSTREAM_REPOSITORY_TOKEN}\")\r\n        elif [[ -n \"${HOMEBREW_GITHUB_API_TOKEN}\" ]]\r\n        then\r\n          CURL_GITHUB_API_ARGS=(\"--header\" \"Authorization: token ${HOMEBREW_GITHUB_API_TOKEN}\")\r\n```",
        "pr_file_module": null
      },
      {
        "comment_id": "1448662463",
        "repo_full_name": "Homebrew/brew",
        "pr_number": 16289,
        "pr_file": "Library/Homebrew/cmd/update.sh",
        "discussion_id": "1448615646",
        "commented_code": "@@ -637,13 +628,36 @@ EOS\n     # the refspec ensures that the default upstream branch gets updated\n     (\n       UPSTREAM_REPOSITORY_URL=\"$(git config remote.origin.url)\"\n+      unset UPSTREAM_REPOSITORY\n+      unset UPSTREAM_REPOSITORY_TOKEN\n \n       # HOMEBREW_UPDATE_FORCE and HOMEBREW_UPDATE_AUTO aren't modified here so ignore subshell warning.\n       # shellcheck disable=SC2030\n-      if [[ \"${UPSTREAM_REPOSITORY_URL}\" == \"https://github.com/\"* ]]\n+\n+      if [[ \"${UPSTREAM_REPOSITORY_URL}\" = \"https://github.com/\"* ]]\n       then\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY_URL#https://github.com/}\"\n         UPSTREAM_REPOSITORY=\"${UPSTREAM_REPOSITORY%.git}\"\n+      elif [[ \"${UPSTREAM_REPOSITORY_URL}\" =~ https://(([^:@]+)(:([^@]+))?@)?github.com/(.*)$ ]]\n+      then\n+        UPSTREAM_REPOSITORY=\"${BASH_REMATCH[5]%.git}\"\n+        UPSTREAM_REPOSITORY_TOKEN=\"${BASH_REMATCH[4]:-${BASH_REMATCH[2]}}\"\n+      fi\n+\n+      if [[ -n \"${UPSTREAM_REPOSITORY}\" ]]\n+      then\n+        # HOMEBREW_GITHUB_API_TOKEN is optionally defined in the user environment.\n+        # Global token HOMEBREW_GITHUB_API_TOKEN supersedes local defined one\n+        # shellcheck disable=SC2153\n+        if [[ -n \"${HOMEBREW_GITHUB_API_TOKEN}\" ]]\n+        then\n+          CURL_GITHUB_API_ARGS=(\"--header\" \"Authorization: token ${HOMEBREW_GITHUB_API_TOKEN}\")\n+        elif [[ -n \"${UPSTREAM_REPOSITORY_TOKEN}\" ]]\n+        then\n+          CURL_GITHUB_API_ARGS=(\"--header\" \"Authorization: token ${UPSTREAM_REPOSITORY_TOKEN}\")",
        "comment_created_at": "2024-01-11T10:52:34+00:00",
        "comment_author": "sazriel26",
        "comment_body": "I have applied this change too but looks opposite to https://github.com/Homebrew/brew/pull/16289#discussion_r1445806904 ...",
        "pr_file_module": null
      }
    ]
  }
]