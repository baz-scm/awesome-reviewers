---
title: Secure network operations
description: 'When performing network operations, prioritize security and configurability
  to ensure robustness across different environments. This includes:


  1. **Use explicit command patterns**: When executing shell commands that involve
  network operations, avoid string interpolation and use argument arrays instead to
  prevent command injection vulnerabilities.'
repository: chef/chef
label: Networking
language: Ruby
comments_count: 4
repository_stars: 7860
---

When performing network operations, prioritize security and configurability to ensure robustness across different environments. This includes:

1. **Use explicit command patterns**: When executing shell commands that involve network operations, avoid string interpolation and use argument arrays instead to prevent command injection vulnerabilities.

```ruby
# Avoid - potential command injection risk
shell_out!("semodule --install '#{selinux_module_filepath('pp')}'")

# Prefer - safer argument passing without shell interpretation
shell_out!("semodule", "--install", selinux_module_filepath('pp'))
```

2. **Make network operations transparent**: When downloading and executing content from the network, clearly document what's happening to avoid confusion and potential security issues.

```ruby
# Unclear - abbreviation hides the operation being performed
powershell_exec("iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))").error!

# Clear - explicitly states what's happening with a clarifying comment
# note that Invoke-Expression is being called on the downloaded script (outer parens)
powershell_exec("Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))").error!
```

3. **Use configurable HTTP options**: When making HTTP requests, provide configurable options through a hash instead of individual properties to allow for flexible and extensible client configuration.

```ruby
# Add to your resource
property :http_options, Hash,
  description: "Configuration options for the HTTP client"

# Then in your provider
def http_client_opts
  defaults = { retries: 5, retry_delay: 2 }
  defaults.merge(new_resource.http_options || {})
end
```

These practices ensure network operations are secure against injection attacks, clearly documented for maintainers, and configurable for different network environments.


[
  {
    "discussion_id": "1369668732",
    "pr_number": 14043,
    "pr_file": "lib/chef/resource/chocolatey_installer.rb",
    "created_at": "2023-10-24T06:12:24+00:00",
    "commented_code": "class Chef\n  class Resource\n    class ChocolateyInstaller < Chef::Resource\n      provides :chocolatey_installer\n\n      description \"Use the Chocolatey Installer resource to ensure that Choco is installed to your specification. Use the Chocolatey Feature resource to customize your install\"\n      introduced \"18.3\"\n      examples <<~DOC\n          **Install Chocolatey**\n\n          ```ruby\n          chocolatey_installer 'latest' do\n            action :install\n          end\n          ```\n\n          **Uninstall Chocolatey**\n\n          ```ruby\n          chocolatey_installer 'Some random verbiage' do\n            action :uninstall\n          end\n          ```\n\n          **Install Chocolatey with Parameters**\n\n          ```ruby\n          chocolatey_installer 'latest' do\n            action :install\n            download_url \"https://www.contoso.com/foo\"\n            chocolatey_version '2.12.24'\n          end\n          ```\n\n          **Upgrade Chocolatey with Parameters**\n\n          ```ruby\n          chocolatey_installer 'latest' do\n            action :upgrade\n            chocolatey_version '2.12.24'\n          end\n          ```\n      DOC\n\n      allowed_actions :install, :uninstall, :upgrade\n\n      property :download_url, String,\n        description: \"The URL to download Chocolatey from. This defaults to the value of $env:ChocolateyDownloadUrl, if it is set, and otherwise falls back to the official Chocolatey community repository to download the Chocolatey package. It can be used for offline installation by providing a path to a Chocolatey.nupkg.\"\n\n      property :chocolatey_version, String,\n        description: \"Specifies a target version of Chocolatey to install. By default, the latest stable version is installed. This will use the value in $env:ChocolateyVersion by default, if that environment variable is present. This parameter is ignored if download_url is set.\"\n\n      property :use_native_unzip, [TrueClass, FalseClass], default: false,\n        description: \"If set, uses built-in Windows decompression tools instead of 7zip when unpacking the downloaded nupkg. This will be set by default if use_native_unzip is set to a value other than 'false' or '0'. This parameter will be ignored in PS 5+ in favour of using the Expand-Archive built in PowerShell cmdlet directly.\"\n\n      property :ignore_proxy, [TrueClass, FalseClass], default: false,\n        description: \"If set, ignores any configured proxy. This will override any proxy environment variables or parameters. This will be set by default if ignore_proxy is set to a value other than 'false' or '0'.\"\n\n      property :proxy_url, String,\n        description: \"Specifies the proxy URL to use during the download.\"\n\n      property :proxy_user, String,\n        description: \"The username to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_password are set\"\n\n      property :proxy_password, String,\n        description: \"The password to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_user are set\"\n\n      load_current_value do\n        current_state = is_choco_installed?\n        current_value_does_not_exist! if current_state == false\n        current_state\n      end\n\n      def is_choco_installed?\n        ::File.exist?(\"#{ENV[\"ALLUSERSPROFILE\"]}\\\\chocolatey\\\\bin\\\\choco.exe\")\n      end\n\n      def get_choco_version\n        powershell_exec(\"choco --version\").result\n      end\n\n      def existing_version\n        Gem::Version.new(get_choco_version)\n      end\n\n      def define_resource_requirements\n        [ new_resource.proxy_user, new_resource.proxy_password ].each do\n          requirements.assert(:install, :upgrade).each do |a|\n            a.assertion do\n              (!new_resource.proxy_user.nil? && new_resource.proxy_password.nil?) || (new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?)\n            end\n            a.failure_message(Chef::Exceptions::ValidationFailed, \"You must specify both a proxy_user and a proxy_password\")\n            a.whyrun(\"Assuming that if you have configured a 'proxy_user' you must also supply a 'proxy_password'\")\n          end\n        end\n      end\n\n      action :install, description: \"Installs Chocolatey package manager\" do\n        unless new_resource.download_url.nil?\n          powershell_exec(\"Set-Item -path env:ChocolateyDownloadUrl -Value #{new_resource.download_url}\")\n        end\n\n        unless new_resource.chocolatey_version.nil?\n          powershell_exec(\"Set-Item -path env:ChocolateyVersion -Value #{new_resource.chocolatey_version}\")\n        end\n\n        if new_resource.use_native_unzip == true\n          powershell_exec(\"Set-Item -path env:ChocolateyUseWindowsCompression -Value true\")\n        end\n\n        if new_resource.ignore_proxy == true\n          powershell_exec(\"Set-Item -path env:ChocolateyIgnoreProxy -Value true\")\n        end\n\n        unless new_resource.proxy_url.nil?\n          powershell_exec(\"Set-Item -path env:ChocolateyProxyLocation -Value #{new_resource.proxy_url}\")\n        end\n\n        unless !new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?\n          powershell_exec(\"Set-Item -path env:ChocolateyProxyUser -Value #{new_resource.proxy_user}; Set-Item -path env:ChocolateyProxyPassword -Value #{new_resource.proxy_password}\")\n        end\n\n        converge_if_changed do\n          powershell_exec(\"iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\").error!",
    "repo_full_name": "chef/chef",
    "discussion_comments": [
      {
        "comment_id": "1369668732",
        "repo_full_name": "chef/chef",
        "pr_number": 14043,
        "pr_file": "lib/chef/resource/chocolatey_installer.rb",
        "discussion_id": "1369668732",
        "commented_code": "@@ -0,0 +1,198 @@\n+class Chef\n+  class Resource\n+    class ChocolateyInstaller < Chef::Resource\n+      provides :chocolatey_installer\n+\n+      description \"Use the Chocolatey Installer resource to ensure that Choco is installed to your specification. Use the Chocolatey Feature resource to customize your install\"\n+      introduced \"18.3\"\n+      examples <<~DOC\n+          **Install Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+          end\n+          ```\n+\n+          **Uninstall Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'Some random verbiage' do\n+            action :uninstall\n+          end\n+          ```\n+\n+          **Install Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+            download_url \"https://www.contoso.com/foo\"\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+\n+          **Upgrade Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :upgrade\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+      DOC\n+\n+      allowed_actions :install, :uninstall, :upgrade\n+\n+      property :download_url, String,\n+        description: \"The URL to download Chocolatey from. This defaults to the value of $env:ChocolateyDownloadUrl, if it is set, and otherwise falls back to the official Chocolatey community repository to download the Chocolatey package. It can be used for offline installation by providing a path to a Chocolatey.nupkg.\"\n+\n+      property :chocolatey_version, String,\n+        description: \"Specifies a target version of Chocolatey to install. By default, the latest stable version is installed. This will use the value in $env:ChocolateyVersion by default, if that environment variable is present. This parameter is ignored if download_url is set.\"\n+\n+      property :use_native_unzip, [TrueClass, FalseClass], default: false,\n+        description: \"If set, uses built-in Windows decompression tools instead of 7zip when unpacking the downloaded nupkg. This will be set by default if use_native_unzip is set to a value other than 'false' or '0'. This parameter will be ignored in PS 5+ in favour of using the Expand-Archive built in PowerShell cmdlet directly.\"\n+\n+      property :ignore_proxy, [TrueClass, FalseClass], default: false,\n+        description: \"If set, ignores any configured proxy. This will override any proxy environment variables or parameters. This will be set by default if ignore_proxy is set to a value other than 'false' or '0'.\"\n+\n+      property :proxy_url, String,\n+        description: \"Specifies the proxy URL to use during the download.\"\n+\n+      property :proxy_user, String,\n+        description: \"The username to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_password are set\"\n+\n+      property :proxy_password, String,\n+        description: \"The password to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_user are set\"\n+\n+      load_current_value do\n+        current_state = is_choco_installed?\n+        current_value_does_not_exist! if current_state == false\n+        current_state\n+      end\n+\n+      def is_choco_installed?\n+        ::File.exist?(\"#{ENV[\"ALLUSERSPROFILE\"]}\\\\chocolatey\\\\bin\\\\choco.exe\")\n+      end\n+\n+      def get_choco_version\n+        powershell_exec(\"choco --version\").result\n+      end\n+\n+      def existing_version\n+        Gem::Version.new(get_choco_version)\n+      end\n+\n+      def define_resource_requirements\n+        [ new_resource.proxy_user, new_resource.proxy_password ].each do\n+          requirements.assert(:install, :upgrade).each do |a|\n+            a.assertion do\n+              (!new_resource.proxy_user.nil? && new_resource.proxy_password.nil?) || (new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?)\n+            end\n+            a.failure_message(Chef::Exceptions::ValidationFailed, \"You must specify both a proxy_user and a proxy_password\")\n+            a.whyrun(\"Assuming that if you have configured a 'proxy_user' you must also supply a 'proxy_password'\")\n+          end\n+        end\n+      end\n+\n+      action :install, description: \"Installs Chocolatey package manager\" do\n+        unless new_resource.download_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyDownloadUrl -Value #{new_resource.download_url}\")\n+        end\n+\n+        unless new_resource.chocolatey_version.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyVersion -Value #{new_resource.chocolatey_version}\")\n+        end\n+\n+        if new_resource.use_native_unzip == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyUseWindowsCompression -Value true\")\n+        end\n+\n+        if new_resource.ignore_proxy == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyIgnoreProxy -Value true\")\n+        end\n+\n+        unless new_resource.proxy_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyLocation -Value #{new_resource.proxy_url}\")\n+        end\n+\n+        unless !new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyUser -Value #{new_resource.proxy_user}; Set-Item -path env:ChocolateyProxyPassword -Value #{new_resource.proxy_password}\")\n+        end\n+\n+        converge_if_changed do\n+          powershell_exec(\"iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\").error!",
        "comment_created_at": "2023-10-24T06:12:24+00:00",
        "comment_author": "jaymzh",
        "comment_body": "This downloads it, but it doesn't run the ps1 that's downloaded... So it's not installed... I think.",
        "pr_file_module": null
      },
      {
        "comment_id": "1370277897",
        "repo_full_name": "chef/chef",
        "pr_number": 14043,
        "pr_file": "lib/chef/resource/chocolatey_installer.rb",
        "discussion_id": "1369668732",
        "commented_code": "@@ -0,0 +1,198 @@\n+class Chef\n+  class Resource\n+    class ChocolateyInstaller < Chef::Resource\n+      provides :chocolatey_installer\n+\n+      description \"Use the Chocolatey Installer resource to ensure that Choco is installed to your specification. Use the Chocolatey Feature resource to customize your install\"\n+      introduced \"18.3\"\n+      examples <<~DOC\n+          **Install Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+          end\n+          ```\n+\n+          **Uninstall Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'Some random verbiage' do\n+            action :uninstall\n+          end\n+          ```\n+\n+          **Install Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+            download_url \"https://www.contoso.com/foo\"\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+\n+          **Upgrade Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :upgrade\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+      DOC\n+\n+      allowed_actions :install, :uninstall, :upgrade\n+\n+      property :download_url, String,\n+        description: \"The URL to download Chocolatey from. This defaults to the value of $env:ChocolateyDownloadUrl, if it is set, and otherwise falls back to the official Chocolatey community repository to download the Chocolatey package. It can be used for offline installation by providing a path to a Chocolatey.nupkg.\"\n+\n+      property :chocolatey_version, String,\n+        description: \"Specifies a target version of Chocolatey to install. By default, the latest stable version is installed. This will use the value in $env:ChocolateyVersion by default, if that environment variable is present. This parameter is ignored if download_url is set.\"\n+\n+      property :use_native_unzip, [TrueClass, FalseClass], default: false,\n+        description: \"If set, uses built-in Windows decompression tools instead of 7zip when unpacking the downloaded nupkg. This will be set by default if use_native_unzip is set to a value other than 'false' or '0'. This parameter will be ignored in PS 5+ in favour of using the Expand-Archive built in PowerShell cmdlet directly.\"\n+\n+      property :ignore_proxy, [TrueClass, FalseClass], default: false,\n+        description: \"If set, ignores any configured proxy. This will override any proxy environment variables or parameters. This will be set by default if ignore_proxy is set to a value other than 'false' or '0'.\"\n+\n+      property :proxy_url, String,\n+        description: \"Specifies the proxy URL to use during the download.\"\n+\n+      property :proxy_user, String,\n+        description: \"The username to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_password are set\"\n+\n+      property :proxy_password, String,\n+        description: \"The password to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_user are set\"\n+\n+      load_current_value do\n+        current_state = is_choco_installed?\n+        current_value_does_not_exist! if current_state == false\n+        current_state\n+      end\n+\n+      def is_choco_installed?\n+        ::File.exist?(\"#{ENV[\"ALLUSERSPROFILE\"]}\\\\chocolatey\\\\bin\\\\choco.exe\")\n+      end\n+\n+      def get_choco_version\n+        powershell_exec(\"choco --version\").result\n+      end\n+\n+      def existing_version\n+        Gem::Version.new(get_choco_version)\n+      end\n+\n+      def define_resource_requirements\n+        [ new_resource.proxy_user, new_resource.proxy_password ].each do\n+          requirements.assert(:install, :upgrade).each do |a|\n+            a.assertion do\n+              (!new_resource.proxy_user.nil? && new_resource.proxy_password.nil?) || (new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?)\n+            end\n+            a.failure_message(Chef::Exceptions::ValidationFailed, \"You must specify both a proxy_user and a proxy_password\")\n+            a.whyrun(\"Assuming that if you have configured a 'proxy_user' you must also supply a 'proxy_password'\")\n+          end\n+        end\n+      end\n+\n+      action :install, description: \"Installs Chocolatey package manager\" do\n+        unless new_resource.download_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyDownloadUrl -Value #{new_resource.download_url}\")\n+        end\n+\n+        unless new_resource.chocolatey_version.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyVersion -Value #{new_resource.chocolatey_version}\")\n+        end\n+\n+        if new_resource.use_native_unzip == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyUseWindowsCompression -Value true\")\n+        end\n+\n+        if new_resource.ignore_proxy == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyIgnoreProxy -Value true\")\n+        end\n+\n+        unless new_resource.proxy_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyLocation -Value #{new_resource.proxy_url}\")\n+        end\n+\n+        unless !new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyUser -Value #{new_resource.proxy_user}; Set-Item -path env:ChocolateyProxyPassword -Value #{new_resource.proxy_password}\")\n+        end\n+\n+        converge_if_changed do\n+          powershell_exec(\"iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\").error!",
        "comment_created_at": "2023-10-24T14:24:11+00:00",
        "comment_author": "johnmccrae",
        "comment_body": "? I ran this on bare metal and it worked?",
        "pr_file_module": null
      },
      {
        "comment_id": "1370284132",
        "repo_full_name": "chef/chef",
        "pr_number": 14043,
        "pr_file": "lib/chef/resource/chocolatey_installer.rb",
        "discussion_id": "1369668732",
        "commented_code": "@@ -0,0 +1,198 @@\n+class Chef\n+  class Resource\n+    class ChocolateyInstaller < Chef::Resource\n+      provides :chocolatey_installer\n+\n+      description \"Use the Chocolatey Installer resource to ensure that Choco is installed to your specification. Use the Chocolatey Feature resource to customize your install\"\n+      introduced \"18.3\"\n+      examples <<~DOC\n+          **Install Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+          end\n+          ```\n+\n+          **Uninstall Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'Some random verbiage' do\n+            action :uninstall\n+          end\n+          ```\n+\n+          **Install Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+            download_url \"https://www.contoso.com/foo\"\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+\n+          **Upgrade Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :upgrade\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+      DOC\n+\n+      allowed_actions :install, :uninstall, :upgrade\n+\n+      property :download_url, String,\n+        description: \"The URL to download Chocolatey from. This defaults to the value of $env:ChocolateyDownloadUrl, if it is set, and otherwise falls back to the official Chocolatey community repository to download the Chocolatey package. It can be used for offline installation by providing a path to a Chocolatey.nupkg.\"\n+\n+      property :chocolatey_version, String,\n+        description: \"Specifies a target version of Chocolatey to install. By default, the latest stable version is installed. This will use the value in $env:ChocolateyVersion by default, if that environment variable is present. This parameter is ignored if download_url is set.\"\n+\n+      property :use_native_unzip, [TrueClass, FalseClass], default: false,\n+        description: \"If set, uses built-in Windows decompression tools instead of 7zip when unpacking the downloaded nupkg. This will be set by default if use_native_unzip is set to a value other than 'false' or '0'. This parameter will be ignored in PS 5+ in favour of using the Expand-Archive built in PowerShell cmdlet directly.\"\n+\n+      property :ignore_proxy, [TrueClass, FalseClass], default: false,\n+        description: \"If set, ignores any configured proxy. This will override any proxy environment variables or parameters. This will be set by default if ignore_proxy is set to a value other than 'false' or '0'.\"\n+\n+      property :proxy_url, String,\n+        description: \"Specifies the proxy URL to use during the download.\"\n+\n+      property :proxy_user, String,\n+        description: \"The username to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_password are set\"\n+\n+      property :proxy_password, String,\n+        description: \"The password to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_user are set\"\n+\n+      load_current_value do\n+        current_state = is_choco_installed?\n+        current_value_does_not_exist! if current_state == false\n+        current_state\n+      end\n+\n+      def is_choco_installed?\n+        ::File.exist?(\"#{ENV[\"ALLUSERSPROFILE\"]}\\\\chocolatey\\\\bin\\\\choco.exe\")\n+      end\n+\n+      def get_choco_version\n+        powershell_exec(\"choco --version\").result\n+      end\n+\n+      def existing_version\n+        Gem::Version.new(get_choco_version)\n+      end\n+\n+      def define_resource_requirements\n+        [ new_resource.proxy_user, new_resource.proxy_password ].each do\n+          requirements.assert(:install, :upgrade).each do |a|\n+            a.assertion do\n+              (!new_resource.proxy_user.nil? && new_resource.proxy_password.nil?) || (new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?)\n+            end\n+            a.failure_message(Chef::Exceptions::ValidationFailed, \"You must specify both a proxy_user and a proxy_password\")\n+            a.whyrun(\"Assuming that if you have configured a 'proxy_user' you must also supply a 'proxy_password'\")\n+          end\n+        end\n+      end\n+\n+      action :install, description: \"Installs Chocolatey package manager\" do\n+        unless new_resource.download_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyDownloadUrl -Value #{new_resource.download_url}\")\n+        end\n+\n+        unless new_resource.chocolatey_version.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyVersion -Value #{new_resource.chocolatey_version}\")\n+        end\n+\n+        if new_resource.use_native_unzip == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyUseWindowsCompression -Value true\")\n+        end\n+\n+        if new_resource.ignore_proxy == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyIgnoreProxy -Value true\")\n+        end\n+\n+        unless new_resource.proxy_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyLocation -Value #{new_resource.proxy_url}\")\n+        end\n+\n+        unless !new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyUser -Value #{new_resource.proxy_user}; Set-Item -path env:ChocolateyProxyPassword -Value #{new_resource.proxy_password}\")\n+        end\n+\n+        converge_if_changed do\n+          powershell_exec(\"iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\").error!",
        "comment_created_at": "2023-10-24T14:27:24+00:00",
        "comment_author": "johnmccrae",
        "comment_body": "testing again",
        "pr_file_module": null
      },
      {
        "comment_id": "1370407701",
        "repo_full_name": "chef/chef",
        "pr_number": 14043,
        "pr_file": "lib/chef/resource/chocolatey_installer.rb",
        "discussion_id": "1369668732",
        "commented_code": "@@ -0,0 +1,198 @@\n+class Chef\n+  class Resource\n+    class ChocolateyInstaller < Chef::Resource\n+      provides :chocolatey_installer\n+\n+      description \"Use the Chocolatey Installer resource to ensure that Choco is installed to your specification. Use the Chocolatey Feature resource to customize your install\"\n+      introduced \"18.3\"\n+      examples <<~DOC\n+          **Install Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+          end\n+          ```\n+\n+          **Uninstall Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'Some random verbiage' do\n+            action :uninstall\n+          end\n+          ```\n+\n+          **Install Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+            download_url \"https://www.contoso.com/foo\"\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+\n+          **Upgrade Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :upgrade\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+      DOC\n+\n+      allowed_actions :install, :uninstall, :upgrade\n+\n+      property :download_url, String,\n+        description: \"The URL to download Chocolatey from. This defaults to the value of $env:ChocolateyDownloadUrl, if it is set, and otherwise falls back to the official Chocolatey community repository to download the Chocolatey package. It can be used for offline installation by providing a path to a Chocolatey.nupkg.\"\n+\n+      property :chocolatey_version, String,\n+        description: \"Specifies a target version of Chocolatey to install. By default, the latest stable version is installed. This will use the value in $env:ChocolateyVersion by default, if that environment variable is present. This parameter is ignored if download_url is set.\"\n+\n+      property :use_native_unzip, [TrueClass, FalseClass], default: false,\n+        description: \"If set, uses built-in Windows decompression tools instead of 7zip when unpacking the downloaded nupkg. This will be set by default if use_native_unzip is set to a value other than 'false' or '0'. This parameter will be ignored in PS 5+ in favour of using the Expand-Archive built in PowerShell cmdlet directly.\"\n+\n+      property :ignore_proxy, [TrueClass, FalseClass], default: false,\n+        description: \"If set, ignores any configured proxy. This will override any proxy environment variables or parameters. This will be set by default if ignore_proxy is set to a value other than 'false' or '0'.\"\n+\n+      property :proxy_url, String,\n+        description: \"Specifies the proxy URL to use during the download.\"\n+\n+      property :proxy_user, String,\n+        description: \"The username to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_password are set\"\n+\n+      property :proxy_password, String,\n+        description: \"The password to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_user are set\"\n+\n+      load_current_value do\n+        current_state = is_choco_installed?\n+        current_value_does_not_exist! if current_state == false\n+        current_state\n+      end\n+\n+      def is_choco_installed?\n+        ::File.exist?(\"#{ENV[\"ALLUSERSPROFILE\"]}\\\\chocolatey\\\\bin\\\\choco.exe\")\n+      end\n+\n+      def get_choco_version\n+        powershell_exec(\"choco --version\").result\n+      end\n+\n+      def existing_version\n+        Gem::Version.new(get_choco_version)\n+      end\n+\n+      def define_resource_requirements\n+        [ new_resource.proxy_user, new_resource.proxy_password ].each do\n+          requirements.assert(:install, :upgrade).each do |a|\n+            a.assertion do\n+              (!new_resource.proxy_user.nil? && new_resource.proxy_password.nil?) || (new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?)\n+            end\n+            a.failure_message(Chef::Exceptions::ValidationFailed, \"You must specify both a proxy_user and a proxy_password\")\n+            a.whyrun(\"Assuming that if you have configured a 'proxy_user' you must also supply a 'proxy_password'\")\n+          end\n+        end\n+      end\n+\n+      action :install, description: \"Installs Chocolatey package manager\" do\n+        unless new_resource.download_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyDownloadUrl -Value #{new_resource.download_url}\")\n+        end\n+\n+        unless new_resource.chocolatey_version.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyVersion -Value #{new_resource.chocolatey_version}\")\n+        end\n+\n+        if new_resource.use_native_unzip == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyUseWindowsCompression -Value true\")\n+        end\n+\n+        if new_resource.ignore_proxy == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyIgnoreProxy -Value true\")\n+        end\n+\n+        unless new_resource.proxy_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyLocation -Value #{new_resource.proxy_url}\")\n+        end\n+\n+        unless !new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyUser -Value #{new_resource.proxy_user}; Set-Item -path env:ChocolateyProxyPassword -Value #{new_resource.proxy_password}\")\n+        end\n+\n+        converge_if_changed do\n+          powershell_exec(\"iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\").error!",
        "comment_created_at": "2023-10-24T15:26:16+00:00",
        "comment_author": "johnmccrae",
        "comment_body": "I see what you're asking now. the IEX at the beginning of the block is a short-cut for Invoke-Expression. So the IEX calls the block which downloads the installer ps1 file then executes it.",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "1370779209",
    "pr_number": 14043,
    "pr_file": "lib/chef/resource/chocolatey_installer.rb",
    "created_at": "2023-10-24T20:31:00+00:00",
    "commented_code": "class Chef\n  class Resource\n    class ChocolateyInstaller < Chef::Resource\n      provides :chocolatey_installer\n\n      description \"Use the Chocolatey Installer resource to ensure that Choco is installed to your specification. Use the Chocolatey Feature resource to customize your install\"\n      introduced \"18.3\"\n      examples <<~DOC\n          **Install Chocolatey**\n\n          ```ruby\n          chocolatey_installer 'latest' do\n            action :install\n          end\n          ```\n\n          **Uninstall Chocolatey**\n\n          ```ruby\n          chocolatey_installer 'Some random verbiage' do\n            action :uninstall\n          end\n          ```\n\n          **Install Chocolatey with Parameters**\n\n          ```ruby\n          chocolatey_installer 'latest' do\n            action :install\n            download_url \"https://www.contoso.com/foo\"\n            chocolatey_version '2.12.24'\n          end\n          ```\n\n          **Upgrade Chocolatey with Parameters**\n\n          ```ruby\n          chocolatey_installer 'latest' do\n            action :upgrade\n            chocolatey_version '2.12.24'\n          end\n          ```\n      DOC\n\n      allowed_actions :install, :uninstall, :upgrade\n\n      property :download_url, String,\n        description: \"The URL to download Chocolatey from. This defaults to the value of $env:ChocolateyDownloadUrl, if it is set, and otherwise falls back to the official Chocolatey community repository to download the Chocolatey package. It can be used for offline installation by providing a path to a Chocolatey.nupkg.\"\n\n      property :chocolatey_version, String,\n        description: \"Specifies a target version of Chocolatey to install. By default, the latest stable version is installed. This will use the value in $env:ChocolateyVersion by default, if that environment variable is present. This parameter is ignored if download_url is set.\"\n\n      property :use_native_unzip, [TrueClass, FalseClass], default: false,\n        description: \"If set, uses built-in Windows decompression tools instead of 7zip when unpacking the downloaded nupkg. This will be set by default if use_native_unzip is set to a value other than 'false' or '0'. This parameter will be ignored in PS 5+ in favour of using the Expand-Archive built in PowerShell cmdlet directly.\"\n\n      property :ignore_proxy, [TrueClass, FalseClass], default: false,\n        description: \"If set, ignores any configured proxy. This will override any proxy environment variables or parameters. This will be set by default if ignore_proxy is set to a value other than 'false' or '0'.\"\n\n      property :proxy_url, String,\n        description: \"Specifies the proxy URL to use during the download.\"\n\n      property :proxy_user, String,\n        description: \"The username to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_password are set\"\n\n      property :proxy_password, String,\n        description: \"The password to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_user are set\"\n\n      load_current_value do\n        current_state = is_choco_installed?\n        current_value_does_not_exist! if current_state == false\n        current_state\n      end\n\n      def is_choco_installed?\n        ::File.exist?(\"#{ENV[\"ALLUSERSPROFILE\"]}\\\\chocolatey\\\\bin\\\\choco.exe\")\n      end\n\n      def get_choco_version\n        powershell_exec(\"choco --version\").result\n      end\n\n      def existing_version\n        Gem::Version.new(get_choco_version)\n      end\n\n      def define_resource_requirements\n        [ new_resource.proxy_user, new_resource.proxy_password ].each do\n          requirements.assert(:install, :upgrade).each do |a|\n            a.assertion do\n              (!new_resource.proxy_user.nil? && new_resource.proxy_password.nil?) || (new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?)\n            end\n            a.failure_message(Chef::Exceptions::ValidationFailed, \"You must specify both a proxy_user and a proxy_password\")\n            a.whyrun(\"Assuming that if you have configured a 'proxy_user' you must also supply a 'proxy_password'\")\n          end\n        end\n      end\n\n      action :install, description: \"Installs Chocolatey package manager\" do\n        unless new_resource.download_url.nil?\n          powershell_exec(\"Set-Item -path env:ChocolateyDownloadUrl -Value #{new_resource.download_url}\")\n        end\n\n        unless new_resource.chocolatey_version.nil?\n          powershell_exec(\"Set-Item -path env:ChocolateyVersion -Value #{new_resource.chocolatey_version}\")\n        end\n\n        if new_resource.use_native_unzip == true\n          powershell_exec(\"Set-Item -path env:ChocolateyUseWindowsCompression -Value true\")\n        end\n\n        if new_resource.ignore_proxy == true\n          powershell_exec(\"Set-Item -path env:ChocolateyIgnoreProxy -Value true\")\n        end\n\n        unless new_resource.proxy_url.nil?\n          powershell_exec(\"Set-Item -path env:ChocolateyProxyLocation -Value #{new_resource.proxy_url}\")\n        end\n\n        unless !new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?\n          powershell_exec(\"Set-Item -path env:ChocolateyProxyUser -Value #{new_resource.proxy_user}; Set-Item -path env:ChocolateyProxyPassword -Value #{new_resource.proxy_password}\")\n        end\n\n        converge_if_changed do\n          powershell_exec(\"iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\").error!",
    "repo_full_name": "chef/chef",
    "discussion_comments": [
      {
        "comment_id": "1370779209",
        "repo_full_name": "chef/chef",
        "pr_number": 14043,
        "pr_file": "lib/chef/resource/chocolatey_installer.rb",
        "discussion_id": "1370779209",
        "commented_code": "@@ -0,0 +1,198 @@\n+class Chef\n+  class Resource\n+    class ChocolateyInstaller < Chef::Resource\n+      provides :chocolatey_installer\n+\n+      description \"Use the Chocolatey Installer resource to ensure that Choco is installed to your specification. Use the Chocolatey Feature resource to customize your install\"\n+      introduced \"18.3\"\n+      examples <<~DOC\n+          **Install Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+          end\n+          ```\n+\n+          **Uninstall Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'Some random verbiage' do\n+            action :uninstall\n+          end\n+          ```\n+\n+          **Install Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+            download_url \"https://www.contoso.com/foo\"\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+\n+          **Upgrade Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :upgrade\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+      DOC\n+\n+      allowed_actions :install, :uninstall, :upgrade\n+\n+      property :download_url, String,\n+        description: \"The URL to download Chocolatey from. This defaults to the value of $env:ChocolateyDownloadUrl, if it is set, and otherwise falls back to the official Chocolatey community repository to download the Chocolatey package. It can be used for offline installation by providing a path to a Chocolatey.nupkg.\"\n+\n+      property :chocolatey_version, String,\n+        description: \"Specifies a target version of Chocolatey to install. By default, the latest stable version is installed. This will use the value in $env:ChocolateyVersion by default, if that environment variable is present. This parameter is ignored if download_url is set.\"\n+\n+      property :use_native_unzip, [TrueClass, FalseClass], default: false,\n+        description: \"If set, uses built-in Windows decompression tools instead of 7zip when unpacking the downloaded nupkg. This will be set by default if use_native_unzip is set to a value other than 'false' or '0'. This parameter will be ignored in PS 5+ in favour of using the Expand-Archive built in PowerShell cmdlet directly.\"\n+\n+      property :ignore_proxy, [TrueClass, FalseClass], default: false,\n+        description: \"If set, ignores any configured proxy. This will override any proxy environment variables or parameters. This will be set by default if ignore_proxy is set to a value other than 'false' or '0'.\"\n+\n+      property :proxy_url, String,\n+        description: \"Specifies the proxy URL to use during the download.\"\n+\n+      property :proxy_user, String,\n+        description: \"The username to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_password are set\"\n+\n+      property :proxy_password, String,\n+        description: \"The password to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_user are set\"\n+\n+      load_current_value do\n+        current_state = is_choco_installed?\n+        current_value_does_not_exist! if current_state == false\n+        current_state\n+      end\n+\n+      def is_choco_installed?\n+        ::File.exist?(\"#{ENV[\"ALLUSERSPROFILE\"]}\\\\chocolatey\\\\bin\\\\choco.exe\")\n+      end\n+\n+      def get_choco_version\n+        powershell_exec(\"choco --version\").result\n+      end\n+\n+      def existing_version\n+        Gem::Version.new(get_choco_version)\n+      end\n+\n+      def define_resource_requirements\n+        [ new_resource.proxy_user, new_resource.proxy_password ].each do\n+          requirements.assert(:install, :upgrade).each do |a|\n+            a.assertion do\n+              (!new_resource.proxy_user.nil? && new_resource.proxy_password.nil?) || (new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?)\n+            end\n+            a.failure_message(Chef::Exceptions::ValidationFailed, \"You must specify both a proxy_user and a proxy_password\")\n+            a.whyrun(\"Assuming that if you have configured a 'proxy_user' you must also supply a 'proxy_password'\")\n+          end\n+        end\n+      end\n+\n+      action :install, description: \"Installs Chocolatey package manager\" do\n+        unless new_resource.download_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyDownloadUrl -Value #{new_resource.download_url}\")\n+        end\n+\n+        unless new_resource.chocolatey_version.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyVersion -Value #{new_resource.chocolatey_version}\")\n+        end\n+\n+        if new_resource.use_native_unzip == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyUseWindowsCompression -Value true\")\n+        end\n+\n+        if new_resource.ignore_proxy == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyIgnoreProxy -Value true\")\n+        end\n+\n+        unless new_resource.proxy_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyLocation -Value #{new_resource.proxy_url}\")\n+        end\n+\n+        unless !new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyUser -Value #{new_resource.proxy_user}; Set-Item -path env:ChocolateyProxyPassword -Value #{new_resource.proxy_password}\")\n+        end\n+\n+        converge_if_changed do\n+          powershell_exec(\"iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\").error!",
        "comment_created_at": "2023-10-24T20:31:00+00:00",
        "comment_author": "tpowell-progress",
        "comment_body": "```suggestion\r\n          # note that Invoke-Expression is being called on the downloaded script (outer parens), not triggering the script download (inner parens)\r\n          powershell_exec(\"Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\").error!\r\n```",
        "pr_file_module": null
      },
      {
        "comment_id": "1371774835",
        "repo_full_name": "chef/chef",
        "pr_number": 14043,
        "pr_file": "lib/chef/resource/chocolatey_installer.rb",
        "discussion_id": "1370779209",
        "commented_code": "@@ -0,0 +1,198 @@\n+class Chef\n+  class Resource\n+    class ChocolateyInstaller < Chef::Resource\n+      provides :chocolatey_installer\n+\n+      description \"Use the Chocolatey Installer resource to ensure that Choco is installed to your specification. Use the Chocolatey Feature resource to customize your install\"\n+      introduced \"18.3\"\n+      examples <<~DOC\n+          **Install Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+          end\n+          ```\n+\n+          **Uninstall Chocolatey**\n+\n+          ```ruby\n+          chocolatey_installer 'Some random verbiage' do\n+            action :uninstall\n+          end\n+          ```\n+\n+          **Install Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :install\n+            download_url \"https://www.contoso.com/foo\"\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+\n+          **Upgrade Chocolatey with Parameters**\n+\n+          ```ruby\n+          chocolatey_installer 'latest' do\n+            action :upgrade\n+            chocolatey_version '2.12.24'\n+          end\n+          ```\n+      DOC\n+\n+      allowed_actions :install, :uninstall, :upgrade\n+\n+      property :download_url, String,\n+        description: \"The URL to download Chocolatey from. This defaults to the value of $env:ChocolateyDownloadUrl, if it is set, and otherwise falls back to the official Chocolatey community repository to download the Chocolatey package. It can be used for offline installation by providing a path to a Chocolatey.nupkg.\"\n+\n+      property :chocolatey_version, String,\n+        description: \"Specifies a target version of Chocolatey to install. By default, the latest stable version is installed. This will use the value in $env:ChocolateyVersion by default, if that environment variable is present. This parameter is ignored if download_url is set.\"\n+\n+      property :use_native_unzip, [TrueClass, FalseClass], default: false,\n+        description: \"If set, uses built-in Windows decompression tools instead of 7zip when unpacking the downloaded nupkg. This will be set by default if use_native_unzip is set to a value other than 'false' or '0'. This parameter will be ignored in PS 5+ in favour of using the Expand-Archive built in PowerShell cmdlet directly.\"\n+\n+      property :ignore_proxy, [TrueClass, FalseClass], default: false,\n+        description: \"If set, ignores any configured proxy. This will override any proxy environment variables or parameters. This will be set by default if ignore_proxy is set to a value other than 'false' or '0'.\"\n+\n+      property :proxy_url, String,\n+        description: \"Specifies the proxy URL to use during the download.\"\n+\n+      property :proxy_user, String,\n+        description: \"The username to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_password are set\"\n+\n+      property :proxy_password, String,\n+        description: \"The password to use to build a proxy credential with. Will be consumed by the proxy_credential property if both this property and proxy_user are set\"\n+\n+      load_current_value do\n+        current_state = is_choco_installed?\n+        current_value_does_not_exist! if current_state == false\n+        current_state\n+      end\n+\n+      def is_choco_installed?\n+        ::File.exist?(\"#{ENV[\"ALLUSERSPROFILE\"]}\\\\chocolatey\\\\bin\\\\choco.exe\")\n+      end\n+\n+      def get_choco_version\n+        powershell_exec(\"choco --version\").result\n+      end\n+\n+      def existing_version\n+        Gem::Version.new(get_choco_version)\n+      end\n+\n+      def define_resource_requirements\n+        [ new_resource.proxy_user, new_resource.proxy_password ].each do\n+          requirements.assert(:install, :upgrade).each do |a|\n+            a.assertion do\n+              (!new_resource.proxy_user.nil? && new_resource.proxy_password.nil?) || (new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?)\n+            end\n+            a.failure_message(Chef::Exceptions::ValidationFailed, \"You must specify both a proxy_user and a proxy_password\")\n+            a.whyrun(\"Assuming that if you have configured a 'proxy_user' you must also supply a 'proxy_password'\")\n+          end\n+        end\n+      end\n+\n+      action :install, description: \"Installs Chocolatey package manager\" do\n+        unless new_resource.download_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyDownloadUrl -Value #{new_resource.download_url}\")\n+        end\n+\n+        unless new_resource.chocolatey_version.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyVersion -Value #{new_resource.chocolatey_version}\")\n+        end\n+\n+        if new_resource.use_native_unzip == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyUseWindowsCompression -Value true\")\n+        end\n+\n+        if new_resource.ignore_proxy == true\n+          powershell_exec(\"Set-Item -path env:ChocolateyIgnoreProxy -Value true\")\n+        end\n+\n+        unless new_resource.proxy_url.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyLocation -Value #{new_resource.proxy_url}\")\n+        end\n+\n+        unless !new_resource.proxy_user.nil? && !new_resource.proxy_password.nil?\n+          powershell_exec(\"Set-Item -path env:ChocolateyProxyUser -Value #{new_resource.proxy_user}; Set-Item -path env:ChocolateyProxyPassword -Value #{new_resource.proxy_password}\")\n+        end\n+\n+        converge_if_changed do\n+          powershell_exec(\"iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))\").error!",
        "comment_created_at": "2023-10-25T13:35:03+00:00",
        "comment_author": "johnmccrae",
        "comment_body": "done",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "831753880",
    "pr_number": 12694,
    "pr_file": "lib/chef/resource/selinux_module.rb",
    "created_at": "2022-03-22T04:14:24+00:00",
    "commented_code": "#\n# Licensed under the Apache License, Version 2.0 (the \"License\");\n# you may not use this file except in compliance with the License.\n# You may obtain a copy of the License at\n#\n#     http://www.apache.org/licenses/LICENSE-2.0\n#\n# Unless required by applicable law or agreed to in writing, software\n# distributed under the License is distributed on an \"AS IS\" BASIS,\n# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n# See the License for the specific language governing permissions and\n# limitations under the License.\n\nrequire_relative \"../resource\"\n\nclass Chef\n  class Resource\n  \tclass SelinuxModule < Chef::Resource\n  \t\tunified_mode true\n\n  \t\tprovides :selinux_module\n\n  \t\tproperty :module_name, String,\n  \t\t          name_property: true,\n  \t\t          description: 'Override the module name'\n\n  \t\tproperty :source, String,\n  \t\t          description: 'Module source file name'\n\n  \t\tproperty :content, String,\n  \t\t          description: 'Module source as String'\n\n  \t\tproperty :cookbook, String,\n  \t\t          description: 'Cookbook to source from module source file from(if it is not located in the current cookbook). The default value is the current cookbook.',\n                desired_state: false\n\n  \t\tproperty :base_dir, String,\n  \t\t          default: '/etc/selinux/local',\n  \t\t          description: 'Directory to create module source file in'\n\n  \t\taction_class do\n  \t\t  def selinux_module_filepath(type)\n  \t\t    path = ::File.join(new_resource.base_dir, \"#{new_resource.module_name}\")\n  \t\t    path.concat(\".#{type}\") if type\n  \t\t  end\n\n  \t\t  def list_installed_modules\n  \t\t    shell_out!('semodule --list-modules').stdout.split(\"\\n\").map { |x| x.split(/\\s/).first }\n  \t\t  end\n  \t\tend\n\n  \t\taction :create do\n  \t\t  directory new_resource.base_dir\n\n  \t\t  if property_is_set?(:content)\n  \t\t    file selinux_module_filepath('te') do\n  \t\t      content new_resource.content\n\n  \t\t      mode '0600'\n  \t\t      owner 'root'\n  \t\t      group 'root'\n\n  \t\t      action :create\n\n  \t\t      notifies :run, \"execute[Compiling SELinux modules at '#{new_resource.base_dir}']\", :immediately\n  \t\t    end\n  \t\t  else\n  \t\t    cookbook_file selinux_module_filepath('te') do\n  \t\t      cookbook new_resource.cookbook\n  \t\t      source new_resource.source\n\n  \t\t      mode '0600'\n  \t\t      owner 'root'\n  \t\t      group 'root'\n\n  \t\t      action :create\n\n  \t\t      notifies :run, \"execute[Compiling SELinux modules at '#{new_resource.base_dir}']\", :immediately\n  \t\t    end\n  \t\t  end\n\n  \t\t  execute \"Compiling SELinux modules at '#{new_resource.base_dir}'\" do\n  \t\t    cwd new_resource.base_dir\n  \t\t    command \"make -C #{new_resource.base_dir} -f /usr/share/selinux/devel/Makefile\"\n  \t\t    timeout 120\n  \t\t    user 'root'\n\n  \t\t    action :nothing\n\n  \t\t    notifies :run, \"execute[Install SELinux module '#{selinux_module_filepath('pp')}']\", :immediately\n  \t\t  end\n\n  \t\t  raise \"Compilation must have failed, no 'pp' file found at: '#{selinux_module_filepath('pp')}'\" unless ::File.exist?(selinux_module_filepath('pp'))\n\n  \t\t  execute \"Install SELinux module '#{selinux_module_filepath('pp')}'\" do\n  \t\t    command \"semodule --install '#{selinux_module_filepath('pp')}'\"\n  \t\t    action :nothing\n  \t\t  end\n  \t\tend\n\n  \t\taction :delete do\n  \t\t  %w(fc if pp te).each do |type|\n  \t\t    next unless ::File.exist?(selinux_module_filepath(type))\n\n  \t\t    file selinux_module_filepath(type) do\n  \t\t      action :delete\n  \t\t    end\n  \t\t  end\n  \t\tend\n\n  \t\taction :install do\n  \t\t  raise \"Module must be compiled before it can be installed, no 'pp' file found at: '#{selinux_module_filepath('pp')}'\" unless ::File.exist?(selinux_module_filepath('pp'))\n\n  \t\t  unless list_installed_modules.include? new_resource.module_name\n  \t\t    converge_by \"Install SELinux module #{selinux_module_filepath('pp')}\" do\n  \t\t      shell_out!(\"semodule --install '#{selinux_module_filepath('pp')}'\")",
    "repo_full_name": "chef/chef",
    "discussion_comments": [
      {
        "comment_id": "831753880",
        "repo_full_name": "chef/chef",
        "pr_number": 12694,
        "pr_file": "lib/chef/resource/selinux_module.rb",
        "discussion_id": "831753880",
        "commented_code": "@@ -0,0 +1,130 @@\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+require_relative \"../resource\"\n+\n+class Chef\n+  class Resource\n+  \tclass SelinuxModule < Chef::Resource\n+  \t\tunified_mode true\n+\n+  \t\tprovides :selinux_module\n+\n+  \t\tproperty :module_name, String,\n+  \t\t          name_property: true,\n+  \t\t          description: 'Override the module name'\n+\n+  \t\tproperty :source, String,\n+  \t\t          description: 'Module source file name'\n+\n+  \t\tproperty :content, String,\n+  \t\t          description: 'Module source as String'\n+\n+  \t\tproperty :cookbook, String,\n+  \t\t          description: 'Cookbook to source from module source file from(if it is not located in the current cookbook). The default value is the current cookbook.',\n+                desired_state: false\n+\n+  \t\tproperty :base_dir, String,\n+  \t\t          default: '/etc/selinux/local',\n+  \t\t          description: 'Directory to create module source file in'\n+\n+  \t\taction_class do\n+  \t\t  def selinux_module_filepath(type)\n+  \t\t    path = ::File.join(new_resource.base_dir, \"#{new_resource.module_name}\")\n+  \t\t    path.concat(\".#{type}\") if type\n+  \t\t  end\n+\n+  \t\t  def list_installed_modules\n+  \t\t    shell_out!('semodule --list-modules').stdout.split(\"\\n\").map { |x| x.split(/\\s/).first }\n+  \t\t  end\n+  \t\tend\n+\n+  \t\taction :create do\n+  \t\t  directory new_resource.base_dir\n+\n+  \t\t  if property_is_set?(:content)\n+  \t\t    file selinux_module_filepath('te') do\n+  \t\t      content new_resource.content\n+\n+  \t\t      mode '0600'\n+  \t\t      owner 'root'\n+  \t\t      group 'root'\n+\n+  \t\t      action :create\n+\n+  \t\t      notifies :run, \"execute[Compiling SELinux modules at '#{new_resource.base_dir}']\", :immediately\n+  \t\t    end\n+  \t\t  else\n+  \t\t    cookbook_file selinux_module_filepath('te') do\n+  \t\t      cookbook new_resource.cookbook\n+  \t\t      source new_resource.source\n+\n+  \t\t      mode '0600'\n+  \t\t      owner 'root'\n+  \t\t      group 'root'\n+\n+  \t\t      action :create\n+\n+  \t\t      notifies :run, \"execute[Compiling SELinux modules at '#{new_resource.base_dir}']\", :immediately\n+  \t\t    end\n+  \t\t  end\n+\n+  \t\t  execute \"Compiling SELinux modules at '#{new_resource.base_dir}'\" do\n+  \t\t    cwd new_resource.base_dir\n+  \t\t    command \"make -C #{new_resource.base_dir} -f /usr/share/selinux/devel/Makefile\"\n+  \t\t    timeout 120\n+  \t\t    user 'root'\n+\n+  \t\t    action :nothing\n+\n+  \t\t    notifies :run, \"execute[Install SELinux module '#{selinux_module_filepath('pp')}']\", :immediately\n+  \t\t  end\n+\n+  \t\t  raise \"Compilation must have failed, no 'pp' file found at: '#{selinux_module_filepath('pp')}'\" unless ::File.exist?(selinux_module_filepath('pp'))\n+\n+  \t\t  execute \"Install SELinux module '#{selinux_module_filepath('pp')}'\" do\n+  \t\t    command \"semodule --install '#{selinux_module_filepath('pp')}'\"\n+  \t\t    action :nothing\n+  \t\t  end\n+  \t\tend\n+\n+  \t\taction :delete do\n+  \t\t  %w(fc if pp te).each do |type|\n+  \t\t    next unless ::File.exist?(selinux_module_filepath(type))\n+\n+  \t\t    file selinux_module_filepath(type) do\n+  \t\t      action :delete\n+  \t\t    end\n+  \t\t  end\n+  \t\tend\n+\n+  \t\taction :install do\n+  \t\t  raise \"Module must be compiled before it can be installed, no 'pp' file found at: '#{selinux_module_filepath('pp')}'\" unless ::File.exist?(selinux_module_filepath('pp'))\n+\n+  \t\t  unless list_installed_modules.include? new_resource.module_name\n+  \t\t    converge_by \"Install SELinux module #{selinux_module_filepath('pp')}\" do\n+  \t\t      shell_out!(\"semodule --install '#{selinux_module_filepath('pp')}'\")",
        "comment_created_at": "2022-03-22T04:14:24+00:00",
        "comment_author": "lamont-granquist",
        "comment_body": "one thing i'd suggest is using:\r\n\r\n```\r\nshell_out!(\"semodule\", \"--install\", selinux_module_filepath('pp'))\r\n```\r\n\r\nthat avoids starting up a shell to parse the command line, and feeds the arguments into argv[0..2] and as a result the quoting of the 2nd argument is no longer necessary.",
        "pr_file_module": null
      },
      {
        "comment_id": "846295912",
        "repo_full_name": "chef/chef",
        "pr_number": 12694,
        "pr_file": "lib/chef/resource/selinux_module.rb",
        "discussion_id": "831753880",
        "commented_code": "@@ -0,0 +1,130 @@\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+\n+require_relative \"../resource\"\n+\n+class Chef\n+  class Resource\n+  \tclass SelinuxModule < Chef::Resource\n+  \t\tunified_mode true\n+\n+  \t\tprovides :selinux_module\n+\n+  \t\tproperty :module_name, String,\n+  \t\t          name_property: true,\n+  \t\t          description: 'Override the module name'\n+\n+  \t\tproperty :source, String,\n+  \t\t          description: 'Module source file name'\n+\n+  \t\tproperty :content, String,\n+  \t\t          description: 'Module source as String'\n+\n+  \t\tproperty :cookbook, String,\n+  \t\t          description: 'Cookbook to source from module source file from(if it is not located in the current cookbook). The default value is the current cookbook.',\n+                desired_state: false\n+\n+  \t\tproperty :base_dir, String,\n+  \t\t          default: '/etc/selinux/local',\n+  \t\t          description: 'Directory to create module source file in'\n+\n+  \t\taction_class do\n+  \t\t  def selinux_module_filepath(type)\n+  \t\t    path = ::File.join(new_resource.base_dir, \"#{new_resource.module_name}\")\n+  \t\t    path.concat(\".#{type}\") if type\n+  \t\t  end\n+\n+  \t\t  def list_installed_modules\n+  \t\t    shell_out!('semodule --list-modules').stdout.split(\"\\n\").map { |x| x.split(/\\s/).first }\n+  \t\t  end\n+  \t\tend\n+\n+  \t\taction :create do\n+  \t\t  directory new_resource.base_dir\n+\n+  \t\t  if property_is_set?(:content)\n+  \t\t    file selinux_module_filepath('te') do\n+  \t\t      content new_resource.content\n+\n+  \t\t      mode '0600'\n+  \t\t      owner 'root'\n+  \t\t      group 'root'\n+\n+  \t\t      action :create\n+\n+  \t\t      notifies :run, \"execute[Compiling SELinux modules at '#{new_resource.base_dir}']\", :immediately\n+  \t\t    end\n+  \t\t  else\n+  \t\t    cookbook_file selinux_module_filepath('te') do\n+  \t\t      cookbook new_resource.cookbook\n+  \t\t      source new_resource.source\n+\n+  \t\t      mode '0600'\n+  \t\t      owner 'root'\n+  \t\t      group 'root'\n+\n+  \t\t      action :create\n+\n+  \t\t      notifies :run, \"execute[Compiling SELinux modules at '#{new_resource.base_dir}']\", :immediately\n+  \t\t    end\n+  \t\t  end\n+\n+  \t\t  execute \"Compiling SELinux modules at '#{new_resource.base_dir}'\" do\n+  \t\t    cwd new_resource.base_dir\n+  \t\t    command \"make -C #{new_resource.base_dir} -f /usr/share/selinux/devel/Makefile\"\n+  \t\t    timeout 120\n+  \t\t    user 'root'\n+\n+  \t\t    action :nothing\n+\n+  \t\t    notifies :run, \"execute[Install SELinux module '#{selinux_module_filepath('pp')}']\", :immediately\n+  \t\t  end\n+\n+  \t\t  raise \"Compilation must have failed, no 'pp' file found at: '#{selinux_module_filepath('pp')}'\" unless ::File.exist?(selinux_module_filepath('pp'))\n+\n+  \t\t  execute \"Install SELinux module '#{selinux_module_filepath('pp')}'\" do\n+  \t\t    command \"semodule --install '#{selinux_module_filepath('pp')}'\"\n+  \t\t    action :nothing\n+  \t\t  end\n+  \t\tend\n+\n+  \t\taction :delete do\n+  \t\t  %w(fc if pp te).each do |type|\n+  \t\t    next unless ::File.exist?(selinux_module_filepath(type))\n+\n+  \t\t    file selinux_module_filepath(type) do\n+  \t\t      action :delete\n+  \t\t    end\n+  \t\t  end\n+  \t\tend\n+\n+  \t\taction :install do\n+  \t\t  raise \"Module must be compiled before it can be installed, no 'pp' file found at: '#{selinux_module_filepath('pp')}'\" unless ::File.exist?(selinux_module_filepath('pp'))\n+\n+  \t\t  unless list_installed_modules.include? new_resource.module_name\n+  \t\t    converge_by \"Install SELinux module #{selinux_module_filepath('pp')}\" do\n+  \t\t      shell_out!(\"semodule --install '#{selinux_module_filepath('pp')}'\")",
        "comment_created_at": "2022-04-08T16:24:41+00:00",
        "comment_author": "neha-p6",
        "comment_body": "Updated for now few occurrences. (Not sure if we should be splitting ones with pipe operator) ",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "687989783",
    "pr_number": 11905,
    "pr_file": "lib/chef/provider/remote_file/http.rb",
    "created_at": "2021-08-12T18:32:45+00:00",
    "commented_code": "def http_client_opts\n          opts = {}\n          # For http request retry and retry_delay was coming from config (default values i.e. retry: 5, retry_delay: 2)\n          # Added retries, retry_delay options to set \"retries\" and \"retry_delay\" properly\n          opts[:retries] = new_resource.retries\n          opts[:retry_delay] = new_resource.retry_delay",
    "repo_full_name": "chef/chef",
    "discussion_comments": [
      {
        "comment_id": "687989783",
        "repo_full_name": "chef/chef",
        "pr_number": 11905,
        "pr_file": "lib/chef/provider/remote_file/http.rb",
        "discussion_id": "687989783",
        "commented_code": "@@ -122,6 +122,10 @@ def etag_from(response)\n \n         def http_client_opts\n           opts = {}\n+          # For http request retry and retry_delay was coming from config (default values i.e. retry: 5, retry_delay: 2)\n+          # Added retries, retry_delay options to set \"retries\" and \"retry_delay\" properly\n+          opts[:retries] = new_resource.retries\n+          opts[:retry_delay] = new_resource.retry_delay",
        "comment_created_at": "2021-08-12T18:32:45+00:00",
        "comment_author": "lamont-granquist",
        "comment_body": "instead of this there should be a `property :http_options` hash added to the remote_file resource and that should be merged with the defaults here in http_client_opts",
        "pr_file_module": null
      },
      {
        "comment_id": "688368989",
        "repo_full_name": "chef/chef",
        "pr_number": 11905,
        "pr_file": "lib/chef/provider/remote_file/http.rb",
        "discussion_id": "687989783",
        "commented_code": "@@ -122,6 +122,10 @@ def etag_from(response)\n \n         def http_client_opts\n           opts = {}\n+          # For http request retry and retry_delay was coming from config (default values i.e. retry: 5, retry_delay: 2)\n+          # Added retries, retry_delay options to set \"retries\" and \"retry_delay\" properly\n+          opts[:retries] = new_resource.retries\n+          opts[:retry_delay] = new_resource.retry_delay",
        "comment_created_at": "2021-08-13T09:16:12+00:00",
        "comment_author": "antima-gupta",
        "comment_body": "Added `property :http_options` , please have look.",
        "pr_file_module": null
      }
    ]
  }
]
