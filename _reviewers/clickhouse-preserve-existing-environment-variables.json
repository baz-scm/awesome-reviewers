[
  {
    "discussion_id": "2282349600",
    "pr_number": 85745,
    "pr_file": "tests/integration/helpers/cluster.py",
    "created_at": "2025-08-18T13:08:36+00:00",
    "commented_code": "#\n         #    [1]: https://github.com/ClickHouse/ClickHouse/issues/43426#issuecomment-1368512678\n         self.env_variables[\"ASAN_OPTIONS\"] = \"use_sigaltstack=0\"\n-        self.env_variables[\"TSAN_OPTIONS\"] = \"use_sigaltstack=0\"\n+        # In integration tests we spawn multiple servers, so let's aim to not more then 5GiB\n+        self.env_variables[\"TSAN_OPTIONS\"] = f\"use_sigaltstack=0 memory_limit_mb=5120\"",
    "repo_full_name": "ClickHouse/ClickHouse",
    "discussion_comments": [
      {
        "comment_id": "2282349600",
        "repo_full_name": "ClickHouse/ClickHouse",
        "pr_number": 85745,
        "pr_file": "tests/integration/helpers/cluster.py",
        "discussion_id": "2282349600",
        "commented_code": "@@ -521,7 +521,8 @@ def __init__(\n         #\n         #    [1]: https://github.com/ClickHouse/ClickHouse/issues/43426#issuecomment-1368512678\n         self.env_variables[\"ASAN_OPTIONS\"] = \"use_sigaltstack=0\"\n-        self.env_variables[\"TSAN_OPTIONS\"] = \"use_sigaltstack=0\"\n+        # In integration tests we spawn multiple servers, so let's aim to not more then 5GiB\n+        self.env_variables[\"TSAN_OPTIONS\"] = f\"use_sigaltstack=0 memory_limit_mb=5120\"",
        "comment_created_at": "2025-08-18T13:08:36+00:00",
        "comment_author": "nickitat",
        "comment_body": "Won't it be too conservative?",
        "pr_file_module": null
      },
      {
        "comment_id": "2282382207",
        "repo_full_name": "ClickHouse/ClickHouse",
        "pr_number": 85745,
        "pr_file": "tests/integration/helpers/cluster.py",
        "discussion_id": "2282349600",
        "commented_code": "@@ -521,7 +521,8 @@ def __init__(\n         #\n         #    [1]: https://github.com/ClickHouse/ClickHouse/issues/43426#issuecomment-1368512678\n         self.env_variables[\"ASAN_OPTIONS\"] = \"use_sigaltstack=0\"\n-        self.env_variables[\"TSAN_OPTIONS\"] = \"use_sigaltstack=0\"\n+        # In integration tests we spawn multiple servers, so let's aim to not more then 5GiB\n+        self.env_variables[\"TSAN_OPTIONS\"] = f\"use_sigaltstack=0 memory_limit_mb=5120\"",
        "comment_created_at": "2025-08-18T13:22:11+00:00",
        "comment_author": "azat",
        "comment_body": "I think it is OK, in integration tests we spawn multiple servers, i.e. we can have 10+ in parallel running, this leaves us with ~6GiB per server, and 5GiB limt for TSan looks reasonable",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "2282365387",
    "pr_number": 85745,
    "pr_file": "ci/jobs/scripts/clickhouse_proc.py",
    "created_at": "2025-08-18T13:15:19+00:00",
    "commented_code": "strict=True,\n         )\n \n+        replicas=3 if self.is_db_replicated else 1\n+        tsan_memory_limit_mb=Utils.physical_memory() * 65 // 100 // 1024 // 1024 // replicas\n+\n+        env = os.environ.copy()\n+        tsan_options = f\"memory_limit_mb={tsan_memory_limit_mb}\"\n+        env[\"TSAN_OPTIONS\"] = tsan_options",
    "repo_full_name": "ClickHouse/ClickHouse",
    "discussion_comments": [
      {
        "comment_id": "2282365387",
        "repo_full_name": "ClickHouse/ClickHouse",
        "pr_number": 85745,
        "pr_file": "ci/jobs/scripts/clickhouse_proc.py",
        "discussion_id": "2282365387",
        "commented_code": "@@ -384,8 +384,20 @@ def start(self, replica_num=0):\n             strict=True,\n         )\n \n+        replicas=3 if self.is_db_replicated else 1\n+        tsan_memory_limit_mb=Utils.physical_memory() * 65 // 100 // 1024 // 1024 // replicas\n+\n+        env = os.environ.copy()\n+        tsan_options = f\"memory_limit_mb={tsan_memory_limit_mb}\"\n+        env[\"TSAN_OPTIONS\"] = tsan_options",
        "comment_created_at": "2025-08-18T13:15:19+00:00",
        "comment_author": "nickitat",
        "comment_body": "Just in case\n\n\n```suggestion\n        env[\"TSAN_OPTIONS\"] = env[\"TSAN_OPTIONS\"] + tsan_options\n```",
        "pr_file_module": null
      },
      {
        "comment_id": "2282407954",
        "repo_full_name": "ClickHouse/ClickHouse",
        "pr_number": 85745,
        "pr_file": "ci/jobs/scripts/clickhouse_proc.py",
        "discussion_id": "2282365387",
        "commented_code": "@@ -384,8 +384,20 @@ def start(self, replica_num=0):\n             strict=True,\n         )\n \n+        replicas=3 if self.is_db_replicated else 1\n+        tsan_memory_limit_mb=Utils.physical_memory() * 65 // 100 // 1024 // 1024 // replicas\n+\n+        env = os.environ.copy()\n+        tsan_options = f\"memory_limit_mb={tsan_memory_limit_mb}\"\n+        env[\"TSAN_OPTIONS\"] = tsan_options",
        "comment_created_at": "2025-08-18T13:32:14+00:00",
        "comment_author": "azat",
        "comment_body": "Make sense, fixed.",
        "pr_file_module": null
      }
    ]
  }
]