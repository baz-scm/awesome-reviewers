[
  {
    "discussion_id": "1898942302",
    "pr_number": 1019,
    "pr_file": "apps/api/src/scraper/scrapeURL/transformers/index.ts",
    "created_at": "2024-12-28T15:27:43+00:00",
    "commented_code": "return document;\n }\n \n+export function encodeRawHTML(_meta: Meta, document: Document): Document {\n+  if (document.rawHtml === undefined) {\n+    throw new Error(\n+      \"rawHtml is undefined -- this transformer is being called out of order\",\n+    );\n+  }\n+\n+  const data: Uint8Array = new TextEncoder().encode(document.rawHtml);\n+\n+  const charsetMatch = document.rawHtml.match(\n+    /<meta[^>]+charset=[\"']?([^\"'>]+)/i,\n+  );\n+  const charset = charsetMatch ? charsetMatch[1] : \"UTF-8\";\n+\n+  try {\n+    // Convert the response data if charset is not UTF-8\n+    if (charset.toUpperCase() !== \"UTF-8\") {\n+      const decoder = new TextDecoder(charset);\n+      document.rawHtml = decoder.decode(data);\n+      \n+      return document;\n+    }",
    "repo_full_name": "firecrawl/firecrawl",
    "discussion_comments": [
      {
        "comment_id": "1898942302",
        "repo_full_name": "firecrawl/firecrawl",
        "pr_number": 1019,
        "pr_file": "apps/api/src/scraper/scrapeURL/transformers/index.ts",
        "discussion_id": "1898942302",
        "commented_code": "@@ -31,6 +31,35 @@ export function deriveMetadataFromRawHTML(\n   return document;\n }\n \n+export function encodeRawHTML(_meta: Meta, document: Document): Document {\n+  if (document.rawHtml === undefined) {\n+    throw new Error(\n+      \"rawHtml is undefined -- this transformer is being called out of order\",\n+    );\n+  }\n+\n+  const data: Uint8Array = new TextEncoder().encode(document.rawHtml);\n+\n+  const charsetMatch = document.rawHtml.match(\n+    /<meta[^>]+charset=[\"']?([^\"'>]+)/i,\n+  );\n+  const charset = charsetMatch ? charsetMatch[1] : \"UTF-8\";\n+\n+  try {\n+    // Convert the response data if charset is not UTF-8\n+    if (charset.toUpperCase() !== \"UTF-8\") {\n+      const decoder = new TextDecoder(charset);\n+      document.rawHtml = decoder.decode(data);\n+      \n+      return document;\n+    }",
        "comment_created_at": "2024-12-28T15:27:43+00:00",
        "comment_author": "mogery",
        "comment_body": "The approach is good, but I think we need to move it to earlier parts of the stack, since the UTF-8 misencode is too destructive to get usable Shift_JIS out of just the parsed string. We need to move it up to a part of the code where we still have access to the raw buffer coming out of the network stack. Let's talk about this on Monday.",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "1818290114",
    "pr_number": 828,
    "pr_file": "apps/api/src/scraper/WebScraper/single_url.ts",
    "created_at": "2024-10-28T02:19:21+00:00",
    "commented_code": "let linksOnPage: string[] | undefined;\n \n     if (pageOptions.includeLinks) {\n-      linksOnPage = extractLinks(rawHtml, urlToScrap);\n+      linksOnPage = extractLinks(html, urlToScrap);",
    "repo_full_name": "firecrawl/firecrawl",
    "discussion_comments": [
      {
        "comment_id": "1818290114",
        "repo_full_name": "firecrawl/firecrawl",
        "pr_number": 828,
        "pr_file": "apps/api/src/scraper/WebScraper/single_url.ts",
        "discussion_id": "1818290114",
        "commented_code": "@@ -447,7 +447,7 @@ export async function scrapSingleUrl(\n     let linksOnPage: string[] | undefined;\n \n     if (pageOptions.includeLinks) {\n-      linksOnPage = extractLinks(rawHtml, urlToScrap);\n+      linksOnPage = extractLinks(html, urlToScrap);",
        "comment_created_at": "2024-10-28T02:19:21+00:00",
        "comment_author": "nickscamara",
        "comment_body": "I think the problem with this is that we rely on this function for our /crawl, which will end up failling to grab all the links if we don't pass the raw version",
        "pr_file_module": null
      },
      {
        "comment_id": "1818290223",
        "repo_full_name": "firecrawl/firecrawl",
        "pr_number": 828,
        "pr_file": "apps/api/src/scraper/WebScraper/single_url.ts",
        "discussion_id": "1818290114",
        "commented_code": "@@ -447,7 +447,7 @@ export async function scrapSingleUrl(\n     let linksOnPage: string[] | undefined;\n \n     if (pageOptions.includeLinks) {\n-      linksOnPage = extractLinks(rawHtml, urlToScrap);\n+      linksOnPage = extractLinks(html, urlToScrap);",
        "comment_created_at": "2024-10-28T02:19:35+00:00",
        "comment_author": "nickscamara",
        "comment_body": "@mogery lmk if im wrong",
        "pr_file_module": null
      },
      {
        "comment_id": "1818792389",
        "repo_full_name": "firecrawl/firecrawl",
        "pr_number": 828,
        "pr_file": "apps/api/src/scraper/WebScraper/single_url.ts",
        "discussion_id": "1818290114",
        "commented_code": "@@ -447,7 +447,7 @@ export async function scrapSingleUrl(\n     let linksOnPage: string[] | undefined;\n \n     if (pageOptions.includeLinks) {\n-      linksOnPage = extractLinks(rawHtml, urlToScrap);\n+      linksOnPage = extractLinks(html, urlToScrap);",
        "comment_created_at": "2024-10-28T10:25:33+00:00",
        "comment_author": "txrp0x9",
        "comment_body": "A global code search did not reveal any usage of the `linksOnPage` field anywhere other than api return\r\nI believe the crawler uses a separate extractLinksFromHTML function\r\nhttps://github.com/mendableai/firecrawl/blob/8a4f4cb9d98884bc70f4cf188a2c4dc87f656462/apps/api/src/services/queue-worker.ts#L374 and \r\nhttps://github.com/mendableai/firecrawl/blob/8a4f4cb9d98884bc70f4cf188a2c4dc87f656462/apps/api/src/scraper/WebScraper/crawler.ts#L382\r\ndefined as\r\nhttps://github.com/mendableai/firecrawl/blob/8a4f4cb9d98884bc70f4cf188a2c4dc87f656462/apps/api/src/scraper/WebScraper/crawler.ts#L322-L337",
        "pr_file_module": null
      },
      {
        "comment_id": "1824860436",
        "repo_full_name": "firecrawl/firecrawl",
        "pr_number": 828,
        "pr_file": "apps/api/src/scraper/WebScraper/single_url.ts",
        "discussion_id": "1818290114",
        "commented_code": "@@ -447,7 +447,7 @@ export async function scrapSingleUrl(\n     let linksOnPage: string[] | undefined;\n \n     if (pageOptions.includeLinks) {\n-      linksOnPage = extractLinks(rawHtml, urlToScrap);\n+      linksOnPage = extractLinks(html, urlToScrap);",
        "comment_created_at": "2024-10-31T17:13:01+00:00",
        "comment_author": "nickscamara",
        "comment_body": "Right makes sense. ",
        "pr_file_module": null
      }
    ]
  }
]