[
  {
    "discussion_id": "783110712",
    "pr_number": 2758,
    "pr_file": "server/control.go",
    "created_at": "2022-01-12T14:12:58+00:00",
    "commented_code": "defer ctl.allShutdown.Start()\n \tdefer ctl.managerShutdown.Done()\n \n-\theartbeat := time.NewTicker(time.Second)\n-\tdefer heartbeat.Stop()\n+\tvar heartbeatCh <-chan time.Time\n+\tif ctl.serverCfg.TCPMux || ctl.serverCfg.HeartbeatTimeout <= 0 {",
    "repo_full_name": "fatedier/frp",
    "discussion_comments": [
      {
        "comment_id": "783110712",
        "repo_full_name": "fatedier/frp",
        "pr_number": 2758,
        "pr_file": "server/control.go",
        "discussion_id": "783110712",
        "commented_code": "@@ -400,12 +400,19 @@ func (ctl *Control) manager() {\n \tdefer ctl.allShutdown.Start()\n \tdefer ctl.managerShutdown.Done()\n \n-\theartbeat := time.NewTicker(time.Second)\n-\tdefer heartbeat.Stop()\n+\tvar heartbeatCh <-chan time.Time\n+\tif ctl.serverCfg.TCPMux || ctl.serverCfg.HeartbeatTimeout <= 0 {",
        "comment_created_at": "2022-01-12T14:12:58+00:00",
        "comment_author": "blizard863",
        "comment_body": "\t// HeartBeatTimeout specifies the maximum time to wait for a heartbeat\r\n\t// before terminating the connection. It is not recommended to change this\r\n\t// value. By default, this value is 90. Set negative value to disable it.\r\n\tHeartbeatTimeout int64 `ini:\"heartbeat_timeout\" json:\"heartbeat_timeout\"`\r\n\r\n描述是小于 0，代码里是 <=0 都忽略 timeout ?\r\n\r\n",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "730447101",
    "pr_number": 2621,
    "pr_file": "client/control.go",
    "created_at": "2021-10-17T17:11:27+00:00",
    "commented_code": "func (ctl *Control) Close() error {",
    "repo_full_name": "fatedier/frp",
    "discussion_comments": [
      {
        "comment_id": "730447101",
        "repo_full_name": "fatedier/frp",
        "pr_number": 2621,
        "pr_file": "client/control.go",
        "discussion_id": "730447101",
        "commented_code": "@@ -183,11 +183,12 @@ func (ctl *Control) HandleNewProxyResp(inMsg *msg.NewProxyResp) {\n \n func (ctl *Control) Close() error {",
        "comment_created_at": "2021-10-17T17:11:27+00:00",
        "comment_author": "fatedier",
        "comment_body": "可以额外增加一个 GracefulClose(gracefulTime time.Duration) 函数。\r\n在外部判断如果是 KCP 再调用这个函数。",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "383013263",
    "pr_number": 1666,
    "pr_file": "server/service.go",
    "created_at": "2020-02-23T15:20:03+00:00",
    "commented_code": "xl.Warn(\"No client control found for run id [%s]\", newMsg.RunId)\n \t\treturn\n \t}\n+\t// Check auth.\n+\tif err := svr.authVerifier.VerifyNewWorkConn(newMsg); err != nil {",
    "repo_full_name": "fatedier/frp",
    "discussion_comments": [
      {
        "comment_id": "383013263",
        "repo_full_name": "fatedier/frp",
        "pr_number": 1666,
        "pr_file": "server/service.go",
        "discussion_id": "383013263",
        "commented_code": "@@ -431,6 +435,11 @@ func (svr *Service) RegisterWorkConn(workConn net.Conn, newMsg *msg.NewWorkConn)\n \t\txl.Warn(\"No client control found for run id [%s]\", newMsg.RunId)\n \t\treturn\n \t}\n+\t// Check auth.\n+\tif err := svr.authVerifier.VerifyNewWorkConn(newMsg); err != nil {",
        "comment_created_at": "2020-02-23T15:20:03+00:00",
        "comment_author": "fatedier",
        "comment_body": "The messages to start a new work connection between frpc and frps is:\r\n```\r\nfrps   ReqWorkConn ->   frpc\r\n       <- NewWorkConn\r\n      StartWorkConn ->\r\n```\r\n\r\nThere are no response for `NewWorkConn` to tell frpc that auth failed. Should we send `NewWorkConnResp` if auth failed or add error info in `StartWorkConn`? And then close the work connection here.",
        "pr_file_module": null
      },
      {
        "comment_id": "383511743",
        "repo_full_name": "fatedier/frp",
        "pr_number": 1666,
        "pr_file": "server/service.go",
        "discussion_id": "383013263",
        "commented_code": "@@ -431,6 +435,11 @@ func (svr *Service) RegisterWorkConn(workConn net.Conn, newMsg *msg.NewWorkConn)\n \t\txl.Warn(\"No client control found for run id [%s]\", newMsg.RunId)\n \t\treturn\n \t}\n+\t// Check auth.\n+\tif err := svr.authVerifier.VerifyNewWorkConn(newMsg); err != nil {",
        "comment_created_at": "2020-02-24T21:01:26+00:00",
        "comment_author": "GuyLewin",
        "comment_body": "@fatedier We still need to close the connection on server side too. So we can respond with a response including an error and then close. The same goes for `pong` messages",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "384669152",
    "pr_number": 1666,
    "pr_file": "client/control.go",
    "created_at": "2020-02-26T18:07:06+00:00",
    "commented_code": "case <-hbSend.C:\n \t\t\t// send heartbeat to server\n \t\t\txl.Debug(\"send heartbeat to server\")\n-\t\t\tpingMsg := &msg.Ping{}\n+\t\t\tpingMsg := &msg.Ping{\n+\t\t\t\tTimestamp: time.Now().Unix(),",
    "repo_full_name": "fatedier/frp",
    "discussion_comments": [
      {
        "comment_id": "384669152",
        "repo_full_name": "fatedier/frp",
        "pr_number": 1666,
        "pr_file": "client/control.go",
        "discussion_id": "384669152",
        "commented_code": "@@ -292,7 +298,9 @@ func (ctl *Control) msgHandler() {\n \t\tcase <-hbSend.C:\n \t\t\t// send heartbeat to server\n \t\t\txl.Debug(\"send heartbeat to server\")\n-\t\t\tpingMsg := &msg.Ping{}\n+\t\t\tpingMsg := &msg.Ping{\n+\t\t\t\tTimestamp: time.Now().Unix(),",
        "comment_created_at": "2020-02-26T18:07:06+00:00",
        "comment_author": "fatedier",
        "comment_body": "No need to set this if `AuthenticateHeartBeats` is false. Move it to `SetPing`?",
        "pr_file_module": null
      },
      {
        "comment_id": "384689424",
        "repo_full_name": "fatedier/frp",
        "pr_number": 1666,
        "pr_file": "client/control.go",
        "discussion_id": "384669152",
        "commented_code": "@@ -292,7 +298,9 @@ func (ctl *Control) msgHandler() {\n \t\tcase <-hbSend.C:\n \t\t\t// send heartbeat to server\n \t\t\txl.Debug(\"send heartbeat to server\")\n-\t\t\tpingMsg := &msg.Ping{}\n+\t\t\tpingMsg := &msg.Ping{\n+\t\t\t\tTimestamp: time.Now().Unix(),",
        "comment_created_at": "2020-02-26T18:44:33+00:00",
        "comment_author": "GuyLewin",
        "comment_body": "@fatedier - do you want the same for NewWorkConn?",
        "pr_file_module": null
      },
      {
        "comment_id": "384887184",
        "repo_full_name": "fatedier/frp",
        "pr_number": 1666,
        "pr_file": "client/control.go",
        "discussion_id": "384669152",
        "commented_code": "@@ -292,7 +298,9 @@ func (ctl *Control) msgHandler() {\n \t\tcase <-hbSend.C:\n \t\t\t// send heartbeat to server\n \t\t\txl.Debug(\"send heartbeat to server\")\n-\t\t\tpingMsg := &msg.Ping{}\n+\t\t\tpingMsg := &msg.Ping{\n+\t\t\t\tTimestamp: time.Now().Unix(),",
        "comment_created_at": "2020-02-27T02:51:14+00:00",
        "comment_author": "fatedier",
        "comment_body": "Yes.",
        "pr_file_module": null
      },
      {
        "comment_id": "385097016",
        "repo_full_name": "fatedier/frp",
        "pr_number": 1666,
        "pr_file": "client/control.go",
        "discussion_id": "384669152",
        "commented_code": "@@ -292,7 +298,9 @@ func (ctl *Control) msgHandler() {\n \t\tcase <-hbSend.C:\n \t\t\t// send heartbeat to server\n \t\t\txl.Debug(\"send heartbeat to server\")\n-\t\t\tpingMsg := &msg.Ping{}\n+\t\t\tpingMsg := &msg.Ping{\n+\t\t\t\tTimestamp: time.Now().Unix(),",
        "comment_created_at": "2020-02-27T12:31:50+00:00",
        "comment_author": "GuyLewin",
        "comment_body": "I wrote on NewWorkConn - I kind of think Timestamp is useful info in these communication packets. If you disagree I can move it like you suggested",
        "pr_file_module": null
      },
      {
        "comment_id": "385106551",
        "repo_full_name": "fatedier/frp",
        "pr_number": 1666,
        "pr_file": "client/control.go",
        "discussion_id": "384669152",
        "commented_code": "@@ -292,7 +298,9 @@ func (ctl *Control) msgHandler() {\n \t\tcase <-hbSend.C:\n \t\t\t// send heartbeat to server\n \t\t\txl.Debug(\"send heartbeat to server\")\n-\t\t\tpingMsg := &msg.Ping{}\n+\t\t\tpingMsg := &msg.Ping{\n+\t\t\t\tTimestamp: time.Now().Unix(),",
        "comment_created_at": "2020-02-27T12:52:12+00:00",
        "comment_author": "fatedier",
        "comment_body": "Some users feedback that they are sensitive to network traffic in embedded devices. I think we'd better remove it if not used especially for heartbeat package.",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "86763822",
    "pr_number": 152,
    "pr_file": "src/models/server/config.go",
    "created_at": "2016-11-07T12:15:01+00:00",
    "commented_code": "LogMaxDays        int64  = 3\n \tPrivilegeMode     bool   = false\n \tPrivilegeToken    string = \"\"\n+\tCtrlConnTimeout   int64  = 10",
    "repo_full_name": "fatedier/frp",
    "discussion_comments": [
      {
        "comment_id": "86763822",
        "repo_full_name": "fatedier/frp",
        "pr_number": 152,
        "pr_file": "src/models/server/config.go",
        "discussion_id": "86763822",
        "commented_code": "@@ -45,6 +45,8 @@ var (\n \tLogMaxDays        int64  = 3\n \tPrivilegeMode     bool   = false\n \tPrivilegeToken    string = \"\"\n+\tCtrlConnTimeout   int64  = 10",
        "comment_created_at": "2016-11-07T12:15:01+00:00",
        "comment_author": "fatedier",
        "comment_body": "默认值为 15 分钟。\n",
        "pr_file_module": null
      },
      {
        "comment_id": "86915928",
        "repo_full_name": "fatedier/frp",
        "pr_number": 152,
        "pr_file": "src/models/server/config.go",
        "discussion_id": "86763822",
        "commented_code": "@@ -45,6 +45,8 @@ var (\n \tLogMaxDays        int64  = 3\n \tPrivilegeMode     bool   = false\n \tPrivilegeToken    string = \"\"\n+\tCtrlConnTimeout   int64  = 10",
        "comment_created_at": "2016-11-08T03:01:58+00:00",
        "comment_author": "maodanp",
        "comment_body": "网络中传输的时间需要15分钟？设置这个值的依据是？\n",
        "pr_file_module": null
      }
    ]
  }
]