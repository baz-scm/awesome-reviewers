[
  {
    "discussion_id": "2194511787",
    "pr_number": 10974,
    "pr_file": "src/helpers/Monitor.cpp",
    "created_at": "2025-07-09T09:20:17+00:00",
    "commented_code": "// lock buffer while DRM/KMS is using it, then release it when page flip happens since DRM/KMS should be done by then\n     // btw buffer's syncReleaser will take care of signaling release point, so we don't do that here\n     PBUFFER->lock();\n-    PBUFFER->onBackendRelease([PBUFFER]() { PBUFFER->unlock(); });\n+    auto weakBuffer = WP<IHLBuffer>(PBUFFER);\n+    PBUFFER->onBackendRelease([weakBuffer]() {\n+        if (auto buffer = weakBuffer.lock())\n+            buffer->unlock();\n+    });",
    "repo_full_name": "hyprwm/Hyprland",
    "discussion_comments": [
      {
        "comment_id": "2194511787",
        "repo_full_name": "hyprwm/Hyprland",
        "pr_number": 10974,
        "pr_file": "src/helpers/Monitor.cpp",
        "discussion_id": "2194511787",
        "commented_code": "@@ -1554,7 +1554,11 @@ bool CMonitor::attemptDirectScanout() {\n     // lock buffer while DRM/KMS is using it, then release it when page flip happens since DRM/KMS should be done by then\n     // btw buffer's syncReleaser will take care of signaling release point, so we don't do that here\n     PBUFFER->lock();\n-    PBUFFER->onBackendRelease([PBUFFER]() { PBUFFER->unlock(); });\n+    auto weakBuffer = WP<IHLBuffer>(PBUFFER);\n+    PBUFFER->onBackendRelease([weakBuffer]() {\n+        if (auto buffer = weakBuffer.lock())\n+            buffer->unlock();\n+    });",
        "comment_created_at": "2025-07-09T09:20:17+00:00",
        "comment_author": "vaxerski",
        "comment_body": "```cpp\r\nPBUFFER->onBackendRelease([wb = WP<IHLBuffer>{PBUFFER}] {\r\n    if (wb)\r\n        wb->unlock();\r\n});\r\n```",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "1996998113",
    "pr_number": 9627,
    "pr_file": "src/protocols/DRMSyncobj.cpp",
    "created_at": "2025-03-15T16:09:12+00:00",
    "commented_code": "return true;\n     }\n \n-    if (!!surface->pending.buffer->acquire != !!surface->pending.buffer->release) {\n-        resource->error(surface->pending.buffer->acquire ? WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_RELEASE_POINT : WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_ACQUIRE_POINT,\n-                        \"Missing timeline\");\n+    if (!surface->pending.buffer->acquire || !surface->pending.buffer->acquire->timeline()) {\n+        resource->error(WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_ACQUIRE_POINT, \"Missing acquire timeline\");\n         surface->pending.rejected = true;\n         return true;\n     }\n \n-    if (surface->pending.buffer->acquire->timeline() == surface->pending.buffer->release->timeline()) {\n+    if (!surface->pending.buffer->release || !surface->pending.buffer->release->timeline()) {\n+        resource->error(WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_RELEASE_POINT, \"Missing release timeline\");\n+        surface->pending.rejected = true;\n+        return true;\n+    }\n+\n+    if (surface->pending.buffer->acquire->timeline().lock() == surface->pending.buffer->release->timeline().lock()) {",
    "repo_full_name": "hyprwm/Hyprland",
    "discussion_comments": [
      {
        "comment_id": "1996998113",
        "repo_full_name": "hyprwm/Hyprland",
        "pr_number": 9627,
        "pr_file": "src/protocols/DRMSyncobj.cpp",
        "discussion_id": "1996998113",
        "commented_code": "@@ -177,14 +177,19 @@ bool CDRMSyncobjSurfaceResource::protocolError() {\n         return true;\n     }\n \n-    if (!!surface->pending.buffer->acquire != !!surface->pending.buffer->release) {\n-        resource->error(surface->pending.buffer->acquire ? WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_RELEASE_POINT : WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_ACQUIRE_POINT,\n-                        \"Missing timeline\");\n+    if (!surface->pending.buffer->acquire || !surface->pending.buffer->acquire->timeline()) {\n+        resource->error(WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_ACQUIRE_POINT, \"Missing acquire timeline\");\n         surface->pending.rejected = true;\n         return true;\n     }\n \n-    if (surface->pending.buffer->acquire->timeline() == surface->pending.buffer->release->timeline()) {\n+    if (!surface->pending.buffer->release || !surface->pending.buffer->release->timeline()) {\n+        resource->error(WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_RELEASE_POINT, \"Missing release timeline\");\n+        surface->pending.rejected = true;\n+        return true;\n+    }\n+\n+    if (surface->pending.buffer->acquire->timeline().lock() == surface->pending.buffer->release->timeline().lock()) {",
        "comment_created_at": "2025-03-15T16:09:12+00:00",
        "comment_author": "vaxerski",
        "comment_body": "double .lock() is redundant",
        "pr_file_module": null
      },
      {
        "comment_id": "1997132103",
        "repo_full_name": "hyprwm/Hyprland",
        "pr_number": 9627,
        "pr_file": "src/protocols/DRMSyncobj.cpp",
        "discussion_id": "1996998113",
        "commented_code": "@@ -177,14 +177,19 @@ bool CDRMSyncobjSurfaceResource::protocolError() {\n         return true;\n     }\n \n-    if (!!surface->pending.buffer->acquire != !!surface->pending.buffer->release) {\n-        resource->error(surface->pending.buffer->acquire ? WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_RELEASE_POINT : WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_ACQUIRE_POINT,\n-                        \"Missing timeline\");\n+    if (!surface->pending.buffer->acquire || !surface->pending.buffer->acquire->timeline()) {\n+        resource->error(WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_ACQUIRE_POINT, \"Missing acquire timeline\");\n         surface->pending.rejected = true;\n         return true;\n     }\n \n-    if (surface->pending.buffer->acquire->timeline() == surface->pending.buffer->release->timeline()) {\n+    if (!surface->pending.buffer->release || !surface->pending.buffer->release->timeline()) {\n+        resource->error(WP_LINUX_DRM_SYNCOBJ_SURFACE_V1_ERROR_NO_RELEASE_POINT, \"Missing release timeline\");\n+        surface->pending.rejected = true;\n+        return true;\n+    }\n+\n+    if (surface->pending.buffer->acquire->timeline().lock() == surface->pending.buffer->release->timeline().lock()) {",
        "comment_created_at": "2025-03-15T17:48:45+00:00",
        "comment_author": "gulafaran",
        "comment_body": "removed.",
        "pr_file_module": null
      }
    ]
  }
]