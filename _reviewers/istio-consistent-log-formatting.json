[
  {
    "discussion_id": "1520450581",
    "pr_number": 49813,
    "pr_file": "pkg/istio-agent/xds_proxy_delta.go",
    "created_at": "2024-03-11T21:25:58+00:00",
    "commented_code": "resp.Resources[i].Resource = resources[i]\n \t}\n \n-\tproxyLog.Debugf(\"forward ECDS resources %+v\", resp.Resources)\n+\tproxyLog.WithLabels(\"resources\", slices.Map(resp.Resources, (*discovery.Resource).GetName), \"removals\", resp.RemovedResources).Debugf(\"forward ECDS\")",
    "repo_full_name": "istio/istio",
    "discussion_comments": [
      {
        "comment_id": "1520450581",
        "repo_full_name": "istio/istio",
        "pr_number": 49813,
        "pr_file": "pkg/istio-agent/xds_proxy_delta.go",
        "discussion_id": "1520450581",
        "commented_code": "@@ -282,7 +296,7 @@ func (p *XdsProxy) deltaRewriteAndForward(con *ProxyConnection, resp *discovery.\n \t\tresp.Resources[i].Resource = resources[i]\n \t}\n \n-\tproxyLog.Debugf(\"forward ECDS resources %+v\", resp.Resources)\n+\tproxyLog.WithLabels(\"resources\", slices.Map(resp.Resources, (*discovery.Resource).GetName), \"removals\", resp.RemovedResources).Debugf(\"forward ECDS\")",
        "comment_created_at": "2024-03-11T21:25:58+00:00",
        "comment_author": "lei-tang",
        "comment_body": " Nit:  On line 220, RemovedResources in the proxyLog has a label = \"removes\" and a label value = len(resp.RemovedResources).\r\n\r\nOn line 299, RemovedResources in the proxyLog has a different label = \"removals\" and a different label value = resp.RemovedResources. \r\n\r\nConsider using a consistent label and value for RemovedResources in the proxyLog, e.g., label=\"removedresources\", lable value=resp.RemovedResources.\r\n\r\n ",
        "pr_file_module": null
      },
      {
        "comment_id": "1520460503",
        "repo_full_name": "istio/istio",
        "pr_number": 49813,
        "pr_file": "pkg/istio-agent/xds_proxy_delta.go",
        "discussion_id": "1520450581",
        "commented_code": "@@ -282,7 +296,7 @@ func (p *XdsProxy) deltaRewriteAndForward(con *ProxyConnection, resp *discovery.\n \t\tresp.Resources[i].Resource = resources[i]\n \t}\n \n-\tproxyLog.Debugf(\"forward ECDS resources %+v\", resp.Resources)\n+\tproxyLog.WithLabels(\"resources\", slices.Map(resp.Resources, (*discovery.Resource).GetName), \"removals\", resp.RemovedResources).Debugf(\"forward ECDS\")",
        "comment_created_at": "2024-03-11T21:37:08+00:00",
        "comment_author": "howardjohn",
        "comment_body": "Thanks, I updated to `removes`",
        "pr_file_module": null
      },
      {
        "comment_id": "1520469800",
        "repo_full_name": "istio/istio",
        "pr_number": 49813,
        "pr_file": "pkg/istio-agent/xds_proxy_delta.go",
        "discussion_id": "1520450581",
        "commented_code": "@@ -282,7 +296,7 @@ func (p *XdsProxy) deltaRewriteAndForward(con *ProxyConnection, resp *discovery.\n \t\tresp.Resources[i].Resource = resources[i]\n \t}\n \n-\tproxyLog.Debugf(\"forward ECDS resources %+v\", resp.Resources)\n+\tproxyLog.WithLabels(\"resources\", slices.Map(resp.Resources, (*discovery.Resource).GetName), \"removals\", resp.RemovedResources).Debugf(\"forward ECDS\")",
        "comment_created_at": "2024-03-11T21:48:18+00:00",
        "comment_author": "lei-tang",
        "comment_body": "Thanks. Why does the label \"removes\" on line 220 have a value=len(resp.RemovedResources) whereas the label \"removes\" on line 299 has a value=resp.RemovedResources? If only logging the len, the label \"removes\" on line 299 should have a value=len(resp.RemovedResources) too. If logging the resp.RemovedResources itself, the label \"removes\" on line 220 should have a value=resp.RemovedResources.",
        "pr_file_module": null
      },
      {
        "comment_id": "1520474378",
        "repo_full_name": "istio/istio",
        "pr_number": 49813,
        "pr_file": "pkg/istio-agent/xds_proxy_delta.go",
        "discussion_id": "1520450581",
        "commented_code": "@@ -282,7 +296,7 @@ func (p *XdsProxy) deltaRewriteAndForward(con *ProxyConnection, resp *discovery.\n \t\tresp.Resources[i].Resource = resources[i]\n \t}\n \n-\tproxyLog.Debugf(\"forward ECDS resources %+v\", resp.Resources)\n+\tproxyLog.WithLabels(\"resources\", slices.Map(resp.Resources, (*discovery.Resource).GetName), \"removals\", resp.RemovedResources).Debugf(\"forward ECDS\")",
        "comment_created_at": "2024-03-11T21:54:19+00:00",
        "comment_author": "howardjohn",
        "comment_body": "For ECDS we know there are likely only a few values, but others have O(10k) so it would be very noisy to add them all. I can make this `len` if you want though",
        "pr_file_module": null
      },
      {
        "comment_id": "1520491397",
        "repo_full_name": "istio/istio",
        "pr_number": 49813,
        "pr_file": "pkg/istio-agent/xds_proxy_delta.go",
        "discussion_id": "1520450581",
        "commented_code": "@@ -282,7 +296,7 @@ func (p *XdsProxy) deltaRewriteAndForward(con *ProxyConnection, resp *discovery.\n \t\tresp.Resources[i].Resource = resources[i]\n \t}\n \n-\tproxyLog.Debugf(\"forward ECDS resources %+v\", resp.Resources)\n+\tproxyLog.WithLabels(\"resources\", slices.Map(resp.Resources, (*discovery.Resource).GetName), \"removals\", resp.RemovedResources).Debugf(\"forward ECDS\")",
        "comment_created_at": "2024-03-11T22:16:59+00:00",
        "comment_author": "lei-tang",
        "comment_body": "A consistent semantic for a label will improve code readability. As resp.RemovedResources may contain a large number of strings, it sounds good to me to log the len of resp.RemovedResources on line 220 and line 299.",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "1018464555",
    "pr_number": 41902,
    "pr_file": "pilot/cmd/pilot-agent/status/server.go",
    "created_at": "2022-11-09T22:14:09+00:00",
    "commented_code": "var envoyCancel, appCancel context.CancelFunc\n \tdefer func() {\n \t\tif envoy != nil {\n-\t\t\tenvoy.Close()\n+\t\t\terr = envoy.Close()\n+\t\t\tif err != nil {\n+\t\t\t\tlog.Infof(\"envoy connection is not closed successfully with error : %s\", err)",
    "repo_full_name": "istio/istio",
    "discussion_comments": [
      {
        "comment_id": "1018464555",
        "repo_full_name": "istio/istio",
        "pr_number": 41902,
        "pr_file": "pilot/cmd/pilot-agent/status/server.go",
        "discussion_id": "1018464555",
        "commented_code": "@@ -493,10 +493,16 @@ func (s *Server) handleStats(w http.ResponseWriter, r *http.Request) {\n \tvar envoyCancel, appCancel context.CancelFunc\n \tdefer func() {\n \t\tif envoy != nil {\n-\t\t\tenvoy.Close()\n+\t\t\terr = envoy.Close()\n+\t\t\tif err != nil {\n+\t\t\t\tlog.Infof(\"envoy connection is not closed successfully with error : %s\", err)",
        "comment_created_at": "2022-11-09T22:14:09+00:00",
        "comment_author": "howardjohn",
        "comment_body": "```suggestion\r\n\t\t\t\tlog.Infof(\"envoy connection is not closed successfully with error: %v\", err)\r\n```\r\n\r\nReally nit but we shouldn't have spaces before `:` and `%s` doesn't really work with err I thought? ",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "1018489134",
    "pr_number": 41902,
    "pr_file": "pkg/istio-agent/agent.go",
    "created_at": "2022-11-09T22:52:24+00:00",
    "commented_code": "if err != nil {\n \t\treturn err\n \t}\n-\tconn.Close()\n+\terr = conn.Close()\n+\tif err != nil {\n+\t\tlog.Infof(\"connection is not closed with error: %v\", err)",
    "repo_full_name": "istio/istio",
    "discussion_comments": [
      {
        "comment_id": "1018489134",
        "repo_full_name": "istio/istio",
        "pr_number": 41902,
        "pr_file": "pkg/istio-agent/agent.go",
        "discussion_id": "1018489134",
        "commented_code": "@@ -691,7 +691,10 @@ func socketHealthCheck(ctx context.Context, socketPath string) error {\n \tif err != nil {\n \t\treturn err\n \t}\n-\tconn.Close()\n+\terr = conn.Close()\n+\tif err != nil {\n+\t\tlog.Infof(\"connection is not closed with error: %v\", err)",
        "comment_created_at": "2022-11-09T22:52:24+00:00",
        "comment_author": "howardjohn",
        "comment_body": "sorry to be nit-picky but since I already had another comment...\r\n\r\n```suggestion\r\n\t\tlog.Infof(\"connection is not closed: %v\", err)\r\n```\r\n\r\nIs the go recommendation for error formats",
        "pr_file_module": null
      }
    ]
  }
]