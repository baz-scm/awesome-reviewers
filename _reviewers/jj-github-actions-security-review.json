[
  {
    "discussion_id": "2292867038",
    "pr_number": 7328,
    "pr_file": ".github/workflows/flakehub-publish-tagged.yml",
    "created_at": "2025-08-22T06:53:33+00:00",
    "commented_code": "+name: \"Publish tags to FlakeHub\"\n+on:\n+  push:\n+    tags:\n+      - \"v?[0-9]+.[0-9]+.[0-9]+*\"\n+  workflow_dispatch:\n+    inputs:\n+      tag:\n+        description: \"The existing tag to publish to FlakeHub\"\n+        type: \"string\"\n+        required: true\n+jobs:\n+  flakehub-publish:\n+    runs-on: \"ubuntu-latest\"\n+    permissions:\n+      id-token: \"write\"",
    "repo_full_name": "jj-vcs/jj",
    "discussion_comments": [
      {
        "comment_id": "2292867038",
        "repo_full_name": "jj-vcs/jj",
        "pr_number": 7328,
        "pr_file": ".github/workflows/flakehub-publish-tagged.yml",
        "discussion_id": "2292867038",
        "commented_code": "@@ -0,0 +1,28 @@\n+name: \"Publish tags to FlakeHub\"\n+on:\n+  push:\n+    tags:\n+      - \"v?[0-9]+.[0-9]+.[0-9]+*\"\n+  workflow_dispatch:\n+    inputs:\n+      tag:\n+        description: \"The existing tag to publish to FlakeHub\"\n+        type: \"string\"\n+        required: true\n+jobs:\n+  flakehub-publish:\n+    runs-on: \"ubuntu-latest\"\n+    permissions:\n+      id-token: \"write\"",
        "comment_created_at": "2025-08-22T06:53:33+00:00",
        "comment_author": "ilyagr",
        "comment_body": "I wonder what this is...",
        "pr_file_module": null
      },
      {
        "comment_id": "2294195603",
        "repo_full_name": "jj-vcs/jj",
        "pr_number": 7328,
        "pr_file": ".github/workflows/flakehub-publish-tagged.yml",
        "discussion_id": "2292867038",
        "commented_code": "@@ -0,0 +1,28 @@\n+name: \"Publish tags to FlakeHub\"\n+on:\n+  push:\n+    tags:\n+      - \"v?[0-9]+.[0-9]+.[0-9]+*\"\n+  workflow_dispatch:\n+    inputs:\n+      tag:\n+        description: \"The existing tag to publish to FlakeHub\"\n+        type: \"string\"\n+        required: true\n+jobs:\n+  flakehub-publish:\n+    runs-on: \"ubuntu-latest\"\n+    permissions:\n+      id-token: \"write\"",
        "comment_created_at": "2025-08-22T16:42:51+00:00",
        "comment_author": "grahamc",
        "comment_body": "It allows GHA actions to request a JWT token on behalf of your repository. It's how flakehub-push authenticates with FlakeHub, instead of static tokens. Recently, crates.io started supporting doing the same thing: https://crates.io/docs/trusted-publishing",
        "pr_file_module": null
      },
      {
        "comment_id": "2294278162",
        "repo_full_name": "jj-vcs/jj",
        "pr_number": 7328,
        "pr_file": ".github/workflows/flakehub-publish-tagged.yml",
        "discussion_id": "2292867038",
        "commented_code": "@@ -0,0 +1,28 @@\n+name: \"Publish tags to FlakeHub\"\n+on:\n+  push:\n+    tags:\n+      - \"v?[0-9]+.[0-9]+.[0-9]+*\"\n+  workflow_dispatch:\n+    inputs:\n+      tag:\n+        description: \"The existing tag to publish to FlakeHub\"\n+        type: \"string\"\n+        required: true\n+jobs:\n+  flakehub-publish:\n+    runs-on: \"ubuntu-latest\"\n+    permissions:\n+      id-token: \"write\"",
        "comment_created_at": "2025-08-22T17:29:03+00:00",
        "comment_author": "ilyagr",
        "comment_body": "I was guessing this is authorization-related, but I worry that I don't understand where the secret is coming from and what has access to it.\r\n\r\nI think the link to https://flakehub.com/user/settings?editview=organizations explains it. It results in requesting these permissions:\r\n\r\n<img width=\"590\" height=\"809\" alt=\"image\" src=\"https://github.com/user-attachments/assets/4821202d-b393-4eff-99cc-e59370a0b407\" />\r\n\r\nI haven't hit that button yet. I could try it, not sure if Google org's policies will allow it, but since I got to that screen -- probably?\r\n\r\nBut at least now it's clear to me what part of this process you need a maintainer for.\r\n\r\nCc: @aesipp, you might be a better person to think about this.\r\n",
        "pr_file_module": null
      },
      {
        "comment_id": "2294339316",
        "repo_full_name": "jj-vcs/jj",
        "pr_number": 7328,
        "pr_file": ".github/workflows/flakehub-publish-tagged.yml",
        "discussion_id": "2292867038",
        "commented_code": "@@ -0,0 +1,28 @@\n+name: \"Publish tags to FlakeHub\"\n+on:\n+  push:\n+    tags:\n+      - \"v?[0-9]+.[0-9]+.[0-9]+*\"\n+  workflow_dispatch:\n+    inputs:\n+      tag:\n+        description: \"The existing tag to publish to FlakeHub\"\n+        type: \"string\"\n+        required: true\n+jobs:\n+  flakehub-publish:\n+    runs-on: \"ubuntu-latest\"\n+    permissions:\n+      id-token: \"write\"",
        "comment_created_at": "2025-08-22T17:59:50+00:00",
        "comment_author": "grahamc",
        "comment_body": "I totally understand. Just for general notes:\r\nThe JWT is created by Github's infrastructure: https://docs.github.com/en/actions/concepts/security/openid-connect\r\n\r\nAny software that runs during this workflow is able to request one during the run. Since it is a JWT, it is passed to FlakeHub's backend for authentication. The token that flakehub-push requests has its audience to `https://api.flakehub.com`:\r\n\r\n* https://github.com/DeterminateSystems/flakehub-push/blob/284fbdee6cdba4d3386262ddf41486e512e59318/src/cli/mod.rs#L15-L20\r\n* https://github.com/DeterminateSystems/flakehub-push/blob/284fbdee6cdba4d3386262ddf41486e512e59318/src/github/mod.rs#L62\r\n\r\nfwiw the token doesn't grant any special powers within GitHub services, only services that have setup a trust relationship on their end.\r\n\r\nI'm also happy to discuss/work with @thoughtpolice on it :) thanks!",
        "pr_file_module": null
      },
      {
        "comment_id": "2294355074",
        "repo_full_name": "jj-vcs/jj",
        "pr_number": 7328,
        "pr_file": ".github/workflows/flakehub-publish-tagged.yml",
        "discussion_id": "2292867038",
        "commented_code": "@@ -0,0 +1,28 @@\n+name: \"Publish tags to FlakeHub\"\n+on:\n+  push:\n+    tags:\n+      - \"v?[0-9]+.[0-9]+.[0-9]+*\"\n+  workflow_dispatch:\n+    inputs:\n+      tag:\n+        description: \"The existing tag to publish to FlakeHub\"\n+        type: \"string\"\n+        required: true\n+jobs:\n+  flakehub-publish:\n+    runs-on: \"ubuntu-latest\"\n+    permissions:\n+      id-token: \"write\"",
        "comment_created_at": "2025-08-22T18:06:02+00:00",
        "comment_author": "ilyagr",
        "comment_body": "I don't imagine it's an immediate problem. It's just that we need to keep in mind that we are taking care of this token now, and have to be careful so that Bad Guys (tm) don't get a hold of it and publish Evil Stuff (tm) to Flakehub.\r\n\r\nFor this reason, I mildly prefer our current manual way of publishing to crates.io. Now that I think of it, perhaps it'd then be consistent to either publish to Flakehub manually, or not to do it, or to decide to automate the publishing to crates.io after all (as @thoughtpolice once wanted to do).",
        "pr_file_module": null
      },
      {
        "comment_id": "2294367467",
        "repo_full_name": "jj-vcs/jj",
        "pr_number": 7328,
        "pr_file": ".github/workflows/flakehub-publish-tagged.yml",
        "discussion_id": "2292867038",
        "commented_code": "@@ -0,0 +1,28 @@\n+name: \"Publish tags to FlakeHub\"\n+on:\n+  push:\n+    tags:\n+      - \"v?[0-9]+.[0-9]+.[0-9]+*\"\n+  workflow_dispatch:\n+    inputs:\n+      tag:\n+        description: \"The existing tag to publish to FlakeHub\"\n+        type: \"string\"\n+        required: true\n+jobs:\n+  flakehub-publish:\n+    runs-on: \"ubuntu-latest\"\n+    permissions:\n+      id-token: \"write\"",
        "comment_created_at": "2025-08-22T18:10:44+00:00",
        "comment_author": "grahamc",
        "comment_body": "Right. There is no long-term token, so it'd have to be some bad-guy actor that abuses it during an actual execution of this workflow. It is possible, but mitigated in terms of access and duration. I understand the concern, though.\r\n\r\nUnfortunately, we don't actually support publishing to FlakeHub manually right now. Only authenticated GitHub Actions / GitLab / a few other platforms are trusted for publishing. This is largely striving towards achieving greater SLSA levels.",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "2294368495",
    "pr_number": 7328,
    "pr_file": ".github/workflows/flakehub-publish-tagged.yml",
    "created_at": "2025-08-22T18:11:09+00:00",
    "commented_code": "+name: \"Publish tags to FlakeHub\"\n+on:\n+  push:\n+    tags:\n+      - \"v?[0-9]+.[0-9]+.[0-9]+*\"\n+  workflow_dispatch:\n+    inputs:\n+      tag:\n+        description: \"The existing tag to publish to FlakeHub\"\n+        type: \"string\"\n+        required: true\n+jobs:\n+  flakehub-publish:\n+    runs-on: \"ubuntu-latest\"\n+    permissions:\n+      id-token: \"write\"\n+      contents: \"read\"\n+    steps:\n+      - uses: \"actions/checkout@v4\"\n+        with:\n+          ref: \"${{ (inputs.tag != null) && format('refs/tags/{0}', inputs.tag) || '' }}\"",
    "repo_full_name": "jj-vcs/jj",
    "discussion_comments": [
      {
        "comment_id": "2294368495",
        "repo_full_name": "jj-vcs/jj",
        "pr_number": 7328,
        "pr_file": ".github/workflows/flakehub-publish-tagged.yml",
        "discussion_id": "2294368495",
        "commented_code": "@@ -0,0 +1,28 @@\n+name: \"Publish tags to FlakeHub\"\n+on:\n+  push:\n+    tags:\n+      - \"v?[0-9]+.[0-9]+.[0-9]+*\"\n+  workflow_dispatch:\n+    inputs:\n+      tag:\n+        description: \"The existing tag to publish to FlakeHub\"\n+        type: \"string\"\n+        required: true\n+jobs:\n+  flakehub-publish:\n+    runs-on: \"ubuntu-latest\"\n+    permissions:\n+      id-token: \"write\"\n+      contents: \"read\"\n+    steps:\n+      - uses: \"actions/checkout@v4\"\n+        with:\n+          ref: \"${{ (inputs.tag != null) && format('refs/tags/{0}', inputs.tag) || '' }}\"",
        "comment_created_at": "2025-08-22T18:11:09+00:00",
        "comment_author": "ilyagr",
        "comment_body": "@grahamc , I don't know whether you can see it, but some security scan (maybe running zizmor with other settings) is unhappy with this line. It's a warning (not an error) that says:\n\n> artipacked: credential persistence through GitHub Actions artifacts\n>\n> Docs: https://docs.zizmor.sh/audits/#artipacked\n\nI haven't looked at what it means, nor whether it's inherent to what the action is doing or could be easily worked around by changing the action a little bit (in which case, you should probably change it for everybody).\n",
        "pr_file_module": null
      },
      {
        "comment_id": "2294373732",
        "repo_full_name": "jj-vcs/jj",
        "pr_number": 7328,
        "pr_file": ".github/workflows/flakehub-publish-tagged.yml",
        "discussion_id": "2294368495",
        "commented_code": "@@ -0,0 +1,28 @@\n+name: \"Publish tags to FlakeHub\"\n+on:\n+  push:\n+    tags:\n+      - \"v?[0-9]+.[0-9]+.[0-9]+*\"\n+  workflow_dispatch:\n+    inputs:\n+      tag:\n+        description: \"The existing tag to publish to FlakeHub\"\n+        type: \"string\"\n+        required: true\n+jobs:\n+  flakehub-publish:\n+    runs-on: \"ubuntu-latest\"\n+    permissions:\n+      id-token: \"write\"\n+      contents: \"read\"\n+    steps:\n+      - uses: \"actions/checkout@v4\"\n+        with:\n+          ref: \"${{ (inputs.tag != null) && format('refs/tags/{0}', inputs.tag) || '' }}\"",
        "comment_created_at": "2025-08-22T18:13:11+00:00",
        "comment_author": "grahamc",
        "comment_body": "Yeah, I saw that, thanks. That issue is because the template didn't specify `persist-credentials: false` (fixed: https://github.com/jj-vcs/jj/pull/7328#discussion_r2294349087). I opened up a ticket internally to fix the wizard \ud83d\udc4d ",
        "pr_file_module": null
      },
      {
        "comment_id": "2294401571",
        "repo_full_name": "jj-vcs/jj",
        "pr_number": 7328,
        "pr_file": ".github/workflows/flakehub-publish-tagged.yml",
        "discussion_id": "2294368495",
        "commented_code": "@@ -0,0 +1,28 @@\n+name: \"Publish tags to FlakeHub\"\n+on:\n+  push:\n+    tags:\n+      - \"v?[0-9]+.[0-9]+.[0-9]+*\"\n+  workflow_dispatch:\n+    inputs:\n+      tag:\n+        description: \"The existing tag to publish to FlakeHub\"\n+        type: \"string\"\n+        required: true\n+jobs:\n+  flakehub-publish:\n+    runs-on: \"ubuntu-latest\"\n+    permissions:\n+      id-token: \"write\"\n+      contents: \"read\"\n+    steps:\n+      - uses: \"actions/checkout@v4\"\n+        with:\n+          ref: \"${{ (inputs.tag != null) && format('refs/tags/{0}', inputs.tag) || '' }}\"",
        "comment_created_at": "2025-08-22T18:29:47+00:00",
        "comment_author": "grahamc",
        "comment_body": "Update: The wizard has been fixed, thanks for flagging it: https://flakehub.com/new",
        "pr_file_module": null
      }
    ]
  }
]