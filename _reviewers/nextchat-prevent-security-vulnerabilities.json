[
  {
    "discussion_id": "1705123686",
    "pr_number": 5181,
    "pr_file": "app/api/auth.ts",
    "created_at": "2024-08-06T08:26:40+00:00",
    "commented_code": "}\n \n     if (systemApiKey) {\n-      console.log(\"[Auth] use system api key\");\n+      console.log(\"[Auth] use system api key\", systemApiKey);",
    "repo_full_name": "ChatGPTNextWeb/NextChat",
    "discussion_comments": [
      {
        "comment_id": "1705123686",
        "repo_full_name": "ChatGPTNextWeb/NextChat",
        "pr_number": 5181,
        "pr_file": "app/api/auth.ts",
        "discussion_id": "1705123686",
        "commented_code": "@@ -98,7 +102,7 @@ export function auth(req: NextRequest, modelProvider: ModelProvider) {\n     }\n \n     if (systemApiKey) {\n-      console.log(\"[Auth] use system api key\");\n+      console.log(\"[Auth] use system api key\", systemApiKey);",
        "comment_created_at": "2024-08-06T08:26:40+00:00",
        "comment_author": "lloydzhou",
        "comment_body": "\u8fd9\u91cc\u4e0d\u5efa\u8bae\u76f4\u63a5\u6253\u5370apikey\u5230\u65e5\u5fd7\u4e2d\uff08\u9274\u4e8e\u4e00\u4e9b\u8fd0\u7ef4\u7684\u7ecf\u9a8c\uff09",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "1523635333",
    "pr_number": 4285,
    "pr_file": "app/api/upstash/[action]/[...key]/route.ts",
    "created_at": "2024-03-13T17:08:26+00:00",
    "commented_code": "async function handle(\n   req: NextRequest,\n-  { params }: { params: { path: string[] } },\n+  { params }: { params: { action: string; key: string[] } },\n ) {\n+  const requestUrl = new URL(req.url);\n+  const endpoint = requestUrl.searchParams.get(\"endpoint\");\n+\n   if (req.method === \"OPTIONS\") {\n     return NextResponse.json({ body: \"OK\" }, { status: 200 });\n   }\n+  const [action, ...key] = params.key;\n+  // only allow to request to *.upstash.io\n+  if (!endpoint || !endpoint.endsWith(\"upstash.io\")) {",
    "repo_full_name": "ChatGPTNextWeb/NextChat",
    "discussion_comments": [
      {
        "comment_id": "1523635333",
        "repo_full_name": "ChatGPTNextWeb/NextChat",
        "pr_number": 4285,
        "pr_file": "app/api/upstash/[action]/[...key]/route.ts",
        "discussion_id": "1523635333",
        "commented_code": "@@ -2,13 +2,42 @@ import { NextRequest, NextResponse } from \"next/server\";\n \n async function handle(\n   req: NextRequest,\n-  { params }: { params: { path: string[] } },\n+  { params }: { params: { action: string; key: string[] } },\n ) {\n+  const requestUrl = new URL(req.url);\n+  const endpoint = requestUrl.searchParams.get(\"endpoint\");\n+\n   if (req.method === \"OPTIONS\") {\n     return NextResponse.json({ body: \"OK\" }, { status: 200 });\n   }\n+  const [action, ...key] = params.key;\n+  // only allow to request to *.upstash.io\n+  if (!endpoint || !endpoint.endsWith(\"upstash.io\")) {",
        "comment_created_at": "2024-03-13T17:08:26+00:00",
        "comment_author": "jokester",
        "comment_body": "is string `endsWith` enough here? It seems still possible to craft a endpoint like `https://arbitrary.url.i.want/path?dummy=upstash.io` and bypass.\r\n\r\nWhat about \r\n\r\n```diff\r\ntry {\r\n  if ( ! (new URL(endpoint).hostname.endswith('.upstash.io')   )  {\r\n   throw 403\r\n }\r\n} catch (e) {\r\n  throw 400\r\n}",
        "pr_file_module": null
      },
      {
        "comment_id": "1523655836",
        "repo_full_name": "ChatGPTNextWeb/NextChat",
        "pr_number": 4285,
        "pr_file": "app/api/upstash/[action]/[...key]/route.ts",
        "discussion_id": "1523635333",
        "commented_code": "@@ -2,13 +2,42 @@ import { NextRequest, NextResponse } from \"next/server\";\n \n async function handle(\n   req: NextRequest,\n-  { params }: { params: { path: string[] } },\n+  { params }: { params: { action: string; key: string[] } },\n ) {\n+  const requestUrl = new URL(req.url);\n+  const endpoint = requestUrl.searchParams.get(\"endpoint\");\n+\n   if (req.method === \"OPTIONS\") {\n     return NextResponse.json({ body: \"OK\" }, { status: 200 });\n   }\n+  const [action, ...key] = params.key;\n+  // only allow to request to *.upstash.io\n+  if (!endpoint || !endpoint.endsWith(\"upstash.io\")) {",
        "comment_created_at": "2024-03-13T17:24:30+00:00",
        "comment_author": "fred-bf",
        "comment_body": "Thanks for reviewing the code. Just updated with the new matching method.",
        "pr_file_module": null
      }
    ]
  }
]