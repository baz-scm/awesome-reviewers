[
  {
    "discussion_id": "2278937773",
    "pr_number": 32356,
    "pr_file": "packages/js/src/executors/node/node.impl.ts",
    "created_at": "2025-08-15T12:52:02+00:00",
    "commented_code": "}\n           }\n \n-          // Before running the program, check if the task has been killed (by a new change during watch).\n-          if (task.killed) return;\n+          if (task.killed || task.cancellationToken.cancelled) return;\n \n           // Run the program\n-          task.promise = new Promise<void>((resolve, reject) => {\n-            const loaderFile =\n-              moduleFormat === 'esm'\n-                ? 'node-with-esm-loader'\n-                : 'node-with-require-overrides';\n-\n-            task.childProcess = fork(\n-              joinPathFragments(__dirname, loaderFile),\n-              options.args ?? [],\n-              {\n-                execArgv: getExecArgv(options),\n-                stdio: [0, 1, 'pipe', 'ipc'],\n-                env: {\n-                  ...process.env,\n-                  NX_FILE_TO_RUN: fileToRunCorrectPath(fileToRun),\n-                  NX_MAPPINGS: JSON.stringify(mappings),\n-                },\n-              }\n-            );\n-\n-            const handleStdErr = (data) => {\n-              // Don't log out error if task is killed and new one has started.\n-              // This could happen if a new build is triggered while new process is starting, since the operation is not atomic.\n-              // Log the error in normal mode\n-              if (!options.watch || !task.killed) {\n-                logger.error(data.toString());\n-              }\n-            };\n-            task.childProcess.stderr.on('data', handleStdErr);\n-            task.childProcess.once('exit', (code) => {\n-              task.childProcess.off('data', handleStdErr);\n-              if (options.watch && !task.killed) {\n-                logger.info(\n-                  `NX Process exited with code ${code}, waiting for changes to restart...`\n-                );\n-              }\n-              if (!options.watch) {\n-                if (code !== 0) {\n-                  error(new Error(`Process exited with code ${code}`));\n-                } else {\n-                  resolve(done());\n+          task.promise = new Promise<{ success: boolean }>(\n+            (resolve, reject) => {\n+              const loaderFile =\n+                moduleFormat === 'esm'\n+                  ? 'node-with-esm-loader'\n+                  : 'node-with-require-overrides';\n+\n+              task.childProcess = fork(\n+                joinPathFragments(__dirname, loaderFile),\n+                options.args ?? [],\n+                {\n+                  execArgv: getExecArgv(options),\n+                  stdio: [0, 'pipe', 'pipe', 'ipc'],\n+                  env: {\n+                    ...process.env,\n+                    NX_FILE_TO_RUN: fileToRunCorrectPath(fileToRun),\n+                    NX_MAPPINGS: JSON.stringify(mappings),\n+                  },\n                 }\n-              }\n-              resolve();\n-            });\n+              );\n+\n+              task.childProcess.stdout?.on('data', (data) => {\n+                globalLineAwareStream.write(data, task.id);",
    "repo_full_name": "nrwl/nx",
    "discussion_comments": [
      {
        "comment_id": "2278937773",
        "repo_full_name": "nrwl/nx",
        "pr_number": 32356,
        "pr_file": "packages/js/src/executors/node/node.impl.ts",
        "discussion_id": "2278937773",
        "commented_code": "@@ -171,71 +172,89 @@ export async function* nodeExecutor(\n             }\n           }\n \n-          // Before running the program, check if the task has been killed (by a new change during watch).\n-          if (task.killed) return;\n+          if (task.killed || task.cancellationToken.cancelled) return;\n \n           // Run the program\n-          task.promise = new Promise<void>((resolve, reject) => {\n-            const loaderFile =\n-              moduleFormat === 'esm'\n-                ? 'node-with-esm-loader'\n-                : 'node-with-require-overrides';\n-\n-            task.childProcess = fork(\n-              joinPathFragments(__dirname, loaderFile),\n-              options.args ?? [],\n-              {\n-                execArgv: getExecArgv(options),\n-                stdio: [0, 1, 'pipe', 'ipc'],\n-                env: {\n-                  ...process.env,\n-                  NX_FILE_TO_RUN: fileToRunCorrectPath(fileToRun),\n-                  NX_MAPPINGS: JSON.stringify(mappings),\n-                },\n-              }\n-            );\n-\n-            const handleStdErr = (data) => {\n-              // Don't log out error if task is killed and new one has started.\n-              // This could happen if a new build is triggered while new process is starting, since the operation is not atomic.\n-              // Log the error in normal mode\n-              if (!options.watch || !task.killed) {\n-                logger.error(data.toString());\n-              }\n-            };\n-            task.childProcess.stderr.on('data', handleStdErr);\n-            task.childProcess.once('exit', (code) => {\n-              task.childProcess.off('data', handleStdErr);\n-              if (options.watch && !task.killed) {\n-                logger.info(\n-                  `NX Process exited with code ${code}, waiting for changes to restart...`\n-                );\n-              }\n-              if (!options.watch) {\n-                if (code !== 0) {\n-                  error(new Error(`Process exited with code ${code}`));\n-                } else {\n-                  resolve(done());\n+          task.promise = new Promise<{ success: boolean }>(\n+            (resolve, reject) => {\n+              const loaderFile =\n+                moduleFormat === 'esm'\n+                  ? 'node-with-esm-loader'\n+                  : 'node-with-require-overrides';\n+\n+              task.childProcess = fork(\n+                joinPathFragments(__dirname, loaderFile),\n+                options.args ?? [],\n+                {\n+                  execArgv: getExecArgv(options),\n+                  stdio: [0, 'pipe', 'pipe', 'ipc'],\n+                  env: {\n+                    ...process.env,\n+                    NX_FILE_TO_RUN: fileToRunCorrectPath(fileToRun),\n+                    NX_MAPPINGS: JSON.stringify(mappings),\n+                  },\n                 }\n-              }\n-              resolve();\n-            });\n+              );\n+\n+              task.childProcess.stdout?.on('data', (data) => {\n+                globalLineAwareStream.write(data, task.id);",
        "comment_created_at": "2025-08-15T12:52:02+00:00",
        "comment_author": "jaysoo",
        "comment_body": "I am wondering if the `LineAwareStream` is needed if we just add:\r\n\r\n```\r\nif (task.id === currentTask.id) {\r\n  process.stdout.write(data);\r\n}\r\n```",
        "pr_file_module": null
      },
      {
        "comment_id": "2278944064",
        "repo_full_name": "nrwl/nx",
        "pr_number": 32356,
        "pr_file": "packages/js/src/executors/node/node.impl.ts",
        "discussion_id": "2278937773",
        "commented_code": "@@ -171,71 +172,89 @@ export async function* nodeExecutor(\n             }\n           }\n \n-          // Before running the program, check if the task has been killed (by a new change during watch).\n-          if (task.killed) return;\n+          if (task.killed || task.cancellationToken.cancelled) return;\n \n           // Run the program\n-          task.promise = new Promise<void>((resolve, reject) => {\n-            const loaderFile =\n-              moduleFormat === 'esm'\n-                ? 'node-with-esm-loader'\n-                : 'node-with-require-overrides';\n-\n-            task.childProcess = fork(\n-              joinPathFragments(__dirname, loaderFile),\n-              options.args ?? [],\n-              {\n-                execArgv: getExecArgv(options),\n-                stdio: [0, 1, 'pipe', 'ipc'],\n-                env: {\n-                  ...process.env,\n-                  NX_FILE_TO_RUN: fileToRunCorrectPath(fileToRun),\n-                  NX_MAPPINGS: JSON.stringify(mappings),\n-                },\n-              }\n-            );\n-\n-            const handleStdErr = (data) => {\n-              // Don't log out error if task is killed and new one has started.\n-              // This could happen if a new build is triggered while new process is starting, since the operation is not atomic.\n-              // Log the error in normal mode\n-              if (!options.watch || !task.killed) {\n-                logger.error(data.toString());\n-              }\n-            };\n-            task.childProcess.stderr.on('data', handleStdErr);\n-            task.childProcess.once('exit', (code) => {\n-              task.childProcess.off('data', handleStdErr);\n-              if (options.watch && !task.killed) {\n-                logger.info(\n-                  `NX Process exited with code ${code}, waiting for changes to restart...`\n-                );\n-              }\n-              if (!options.watch) {\n-                if (code !== 0) {\n-                  error(new Error(`Process exited with code ${code}`));\n-                } else {\n-                  resolve(done());\n+          task.promise = new Promise<{ success: boolean }>(\n+            (resolve, reject) => {\n+              const loaderFile =\n+                moduleFormat === 'esm'\n+                  ? 'node-with-esm-loader'\n+                  : 'node-with-require-overrides';\n+\n+              task.childProcess = fork(\n+                joinPathFragments(__dirname, loaderFile),\n+                options.args ?? [],\n+                {\n+                  execArgv: getExecArgv(options),\n+                  stdio: [0, 'pipe', 'pipe', 'ipc'],\n+                  env: {\n+                    ...process.env,\n+                    NX_FILE_TO_RUN: fileToRunCorrectPath(fileToRun),\n+                    NX_MAPPINGS: JSON.stringify(mappings),\n+                  },\n                 }\n-              }\n-              resolve();\n-            });\n+              );\n+\n+              task.childProcess.stdout?.on('data', (data) => {\n+                globalLineAwareStream.write(data, task.id);",
        "comment_created_at": "2025-08-15T12:56:15+00:00",
        "comment_author": "Coly010",
        "comment_body": "The line aware stream class is specifically to help prevent this issue, by ensuring we're only writing full lines:\r\n<img width=\"845\" height=\"505\" alt=\"image\" src=\"https://github.com/user-attachments/assets/d04b0b9a-2dc1-461f-a44e-35d119573dd1\" />\r\n",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "2131835213",
    "pr_number": 31482,
    "pr_file": "e2e/utils/global-setup.ts",
    "created_at": "2025-06-06T09:11:57+00:00",
    "commented_code": "process.env.NX_TASK_TARGET_TARGET?.startsWith(prefix)\n     );\n \n-    const listenAddress = 'localhost';\n-    const port = process.env.NX_LOCAL_REGISTRY_PORT ?? '4873';\n-    const registry = `http://${listenAddress}:${port}`;\n+    const defaultRegistry = 'https://registry.npmjs.org/';\n     const authToken = 'secretVerdaccioToken';\n \n-    while (true) {\n-      await new Promise((resolve) => setTimeout(resolve, 250));\n-      try {\n-        await assertLocalRegistryIsRunning(registry);\n-        break;\n-      } catch {\n-        console.log(`Waiting for Local registry to start on ${registry}...`);\n-      }\n-    }\n+    // Get the currently configured registry\n+    let currentRegistry = getCurrentRegistry();\n \n-    process.env.npm_config_registry = registry;\n-    execSync(\n-      `npm config set //${listenAddress}:${port}/:_authToken \"${authToken}\" --ws=false`,\n-      {\n-        windowsHide: false,\n+    // If configured registry is the default, start local registry and wait for it to change\n+    if (currentRegistry === defaultRegistry) {\n+      console.log('Default registry detected, starting local registry...');\n+\n+      // Start the local registry\n+      localRegistryProcess = await startLocalRegistry(isVerbose);\n+\n+      // Keep checking until the configured registry changes from default\n+      while (currentRegistry === defaultRegistry) {\n+        console.log(\n+          'Waiting for registry configuration to change from default...'",
    "repo_full_name": "nrwl/nx",
    "discussion_comments": [
      {
        "comment_id": "2131835213",
        "repo_full_name": "nrwl/nx",
        "pr_number": 31482,
        "pr_file": "e2e/utils/global-setup.ts",
        "discussion_id": "2131835213",
        "commented_code": "@@ -20,46 +22,38 @@ export default async function (globalConfig: Config.ConfigGlobals) {\n       process.env.NX_TASK_TARGET_TARGET?.startsWith(prefix)\n     );\n \n-    const listenAddress = 'localhost';\n-    const port = process.env.NX_LOCAL_REGISTRY_PORT ?? '4873';\n-    const registry = `http://${listenAddress}:${port}`;\n+    const defaultRegistry = 'https://registry.npmjs.org/';\n     const authToken = 'secretVerdaccioToken';\n \n-    while (true) {\n-      await new Promise((resolve) => setTimeout(resolve, 250));\n-      try {\n-        await assertLocalRegistryIsRunning(registry);\n-        break;\n-      } catch {\n-        console.log(`Waiting for Local registry to start on ${registry}...`);\n-      }\n-    }\n+    // Get the currently configured registry\n+    let currentRegistry = getCurrentRegistry();\n \n-    process.env.npm_config_registry = registry;\n-    execSync(\n-      `npm config set //${listenAddress}:${port}/:_authToken \"${authToken}\" --ws=false`,\n-      {\n-        windowsHide: false,\n+    // If configured registry is the default, start local registry and wait for it to change\n+    if (currentRegistry === defaultRegistry) {\n+      console.log('Default registry detected, starting local registry...');\n+\n+      // Start the local registry\n+      localRegistryProcess = await startLocalRegistry(isVerbose);\n+\n+      // Keep checking until the configured registry changes from default\n+      while (currentRegistry === defaultRegistry) {\n+        console.log(\n+          'Waiting for registry configuration to change from default...'",
        "comment_created_at": "2025-06-06T09:11:57+00:00",
        "comment_author": "JamesHenry",
        "comment_body": "Maybe include what the default is in the log to avoid any confusion",
        "pr_file_module": null
      },
      {
        "comment_id": "2132603552",
        "repo_full_name": "nrwl/nx",
        "pr_number": 31482,
        "pr_file": "e2e/utils/global-setup.ts",
        "discussion_id": "2131835213",
        "commented_code": "@@ -20,46 +22,38 @@ export default async function (globalConfig: Config.ConfigGlobals) {\n       process.env.NX_TASK_TARGET_TARGET?.startsWith(prefix)\n     );\n \n-    const listenAddress = 'localhost';\n-    const port = process.env.NX_LOCAL_REGISTRY_PORT ?? '4873';\n-    const registry = `http://${listenAddress}:${port}`;\n+    const defaultRegistry = 'https://registry.npmjs.org/';\n     const authToken = 'secretVerdaccioToken';\n \n-    while (true) {\n-      await new Promise((resolve) => setTimeout(resolve, 250));\n-      try {\n-        await assertLocalRegistryIsRunning(registry);\n-        break;\n-      } catch {\n-        console.log(`Waiting for Local registry to start on ${registry}...`);\n-      }\n-    }\n+    // Get the currently configured registry\n+    let currentRegistry = getCurrentRegistry();\n \n-    process.env.npm_config_registry = registry;\n-    execSync(\n-      `npm config set //${listenAddress}:${port}/:_authToken \"${authToken}\" --ws=false`,\n-      {\n-        windowsHide: false,\n+    // If configured registry is the default, start local registry and wait for it to change\n+    if (currentRegistry === defaultRegistry) {\n+      console.log('Default registry detected, starting local registry...');\n+\n+      // Start the local registry\n+      localRegistryProcess = await startLocalRegistry(isVerbose);\n+\n+      // Keep checking until the configured registry changes from default\n+      while (currentRegistry === defaultRegistry) {\n+        console.log(\n+          'Waiting for registry configuration to change from default...'",
        "comment_created_at": "2025-06-06T17:39:17+00:00",
        "comment_author": "FrozenPandaz",
        "comment_body": "@claude can you include the default in the log please?",
        "pr_file_module": null
      },
      {
        "comment_id": "2132972584",
        "repo_full_name": "nrwl/nx",
        "pr_number": 31482,
        "pr_file": "e2e/utils/global-setup.ts",
        "discussion_id": "2131835213",
        "commented_code": "@@ -20,46 +22,38 @@ export default async function (globalConfig: Config.ConfigGlobals) {\n       process.env.NX_TASK_TARGET_TARGET?.startsWith(prefix)\n     );\n \n-    const listenAddress = 'localhost';\n-    const port = process.env.NX_LOCAL_REGISTRY_PORT ?? '4873';\n-    const registry = `http://${listenAddress}:${port}`;\n+    const defaultRegistry = 'https://registry.npmjs.org/';\n     const authToken = 'secretVerdaccioToken';\n \n-    while (true) {\n-      await new Promise((resolve) => setTimeout(resolve, 250));\n-      try {\n-        await assertLocalRegistryIsRunning(registry);\n-        break;\n-      } catch {\n-        console.log(`Waiting for Local registry to start on ${registry}...`);\n-      }\n-    }\n+    // Get the currently configured registry\n+    let currentRegistry = getCurrentRegistry();\n \n-    process.env.npm_config_registry = registry;\n-    execSync(\n-      `npm config set //${listenAddress}:${port}/:_authToken \"${authToken}\" --ws=false`,\n-      {\n-        windowsHide: false,\n+    // If configured registry is the default, start local registry and wait for it to change\n+    if (currentRegistry === defaultRegistry) {\n+      console.log('Default registry detected, starting local registry...');\n+\n+      // Start the local registry\n+      localRegistryProcess = await startLocalRegistry(isVerbose);\n+\n+      // Keep checking until the configured registry changes from default\n+      while (currentRegistry === defaultRegistry) {\n+        console.log(\n+          'Waiting for registry configuration to change from default...'",
        "comment_created_at": "2025-06-06T22:25:56+00:00",
        "comment_author": "FrozenPandaz",
        "comment_body": "@claude Instead of printing `default (https://registry.npmjs.org/)`, just print the default URL.",
        "pr_file_module": null
      }
    ]
  }
]