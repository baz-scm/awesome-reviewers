[
  {
    "discussion_id": "2319153503",
    "pr_number": 32557,
    "pr_file": "packages/nx/src/utils/provenance.ts",
    "created_at": "2025-09-03T14:23:13+00:00",
    "commented_code": "+import { execFile } from 'child_process';\n+import { promisify } from 'util';\n+\n+export async function checkPackageHasProvenance(\n+  packageName: string,\n+  packageVersion: string\n+): Promise<{\n+  success: boolean;\n+  error?: string;\n+}> {\n+  // this is used for locally released versions without provenance\n+  // do not set this for other reasons or you might be exposed to security risks\n+  if (process.env.NX_MIGRATE_SKIP_PROVENANCE_CHECK) {\n+    return {\n+      success: true,\n+    };\n+  }\n+  const execFileAsync = promisify(execFile);\n+\n+  const npmViewResult = JSON.parse(\n+    (\n+      await execFileAsync(\n+        'npm',\n+        ['view', `${packageName}@${packageVersion}`, '--json'],\n+        {\n+          timeout: 20000,\n+        }\n+      )\n+    ).stdout.trim()\n+  );\n+\n+  const attURL = npmViewResult.dist?.attestations?.url;\n+\n+  if (!attURL) return { success: false, error: 'No attestation URL found' };\n+\n+  // refer to https://slsa.dev/spec/v1.1/provenance#schema for the shape of this object\n+  const attestations = (await (await fetch(attURL)).json()) as any;\n+\n+  const provenanceAttestation = attestations?.attestations?.find(\n+    (a) => a.predicateType === 'https://slsa.dev/provenance/v1'\n+  );\n+  if (!provenanceAttestation)\n+    return { success: false, error: 'No provenance attestation found' };\n+\n+  const dsseEnvelopePayload = JSON.parse(\n+    Buffer.from(\n+      provenanceAttestation.bundle.dsseEnvelope.payload,\n+      'base64'\n+    ).toString()\n+  );\n+\n+  const workflowParameters =\n+    dsseEnvelopePayload?.predicate?.buildDefinition?.externalParameters\n+      ?.workflow;\n+\n+  // verify that provenance was actually generated from the right publishing workflow\n+  if (workflowParameters?.repository !== 'https://github.com/nrwl/nx') {\n+    return { success: false, error: 'Repository does not match nrwl/nx' };\n+  }\n+  if (workflowParameters?.path !== '.github/workflows/publish.yml') {\n+    return {\n+      success: false,\n+      error: 'Publishing workflow does not match .github/workflows/publish.yml',",
    "repo_full_name": "nrwl/nx",
    "discussion_comments": [
      {
        "comment_id": "2319153503",
        "repo_full_name": "nrwl/nx",
        "pr_number": 32557,
        "pr_file": "packages/nx/src/utils/provenance.ts",
        "discussion_id": "2319153503",
        "commented_code": "@@ -0,0 +1,95 @@\n+import { execFile } from 'child_process';\n+import { promisify } from 'util';\n+\n+export async function checkPackageHasProvenance(\n+  packageName: string,\n+  packageVersion: string\n+): Promise<{\n+  success: boolean;\n+  error?: string;\n+}> {\n+  // this is used for locally released versions without provenance\n+  // do not set this for other reasons or you might be exposed to security risks\n+  if (process.env.NX_MIGRATE_SKIP_PROVENANCE_CHECK) {\n+    return {\n+      success: true,\n+    };\n+  }\n+  const execFileAsync = promisify(execFile);\n+\n+  const npmViewResult = JSON.parse(\n+    (\n+      await execFileAsync(\n+        'npm',\n+        ['view', `${packageName}@${packageVersion}`, '--json'],\n+        {\n+          timeout: 20000,\n+        }\n+      )\n+    ).stdout.trim()\n+  );\n+\n+  const attURL = npmViewResult.dist?.attestations?.url;\n+\n+  if (!attURL) return { success: false, error: 'No attestation URL found' };\n+\n+  // refer to https://slsa.dev/spec/v1.1/provenance#schema for the shape of this object\n+  const attestations = (await (await fetch(attURL)).json()) as any;\n+\n+  const provenanceAttestation = attestations?.attestations?.find(\n+    (a) => a.predicateType === 'https://slsa.dev/provenance/v1'\n+  );\n+  if (!provenanceAttestation)\n+    return { success: false, error: 'No provenance attestation found' };\n+\n+  const dsseEnvelopePayload = JSON.parse(\n+    Buffer.from(\n+      provenanceAttestation.bundle.dsseEnvelope.payload,\n+      'base64'\n+    ).toString()\n+  );\n+\n+  const workflowParameters =\n+    dsseEnvelopePayload?.predicate?.buildDefinition?.externalParameters\n+      ?.workflow;\n+\n+  // verify that provenance was actually generated from the right publishing workflow\n+  if (workflowParameters?.repository !== 'https://github.com/nrwl/nx') {\n+    return { success: false, error: 'Repository does not match nrwl/nx' };\n+  }\n+  if (workflowParameters?.path !== '.github/workflows/publish.yml') {\n+    return {\n+      success: false,\n+      error: 'Publishing workflow does not match .github/workflows/publish.yml',",
        "comment_created_at": "2025-09-03T14:23:13+00:00",
        "comment_author": "FrozenPandaz",
        "comment_body": "This would be more idiomatic if it threw an Error vs not throw an Error (indicating success).\n\nAlso, I think the error messages should show remediation steps. Maybe double-check if the version is actually proper. And also show that this check can be skipped so users have a way around it if for some reason the version if proper.\n\nI also know.. sometimes I visit npmjs.com and it has trouble fetching provenance? \ud83e\udd14 If the attestation servers are down, users might want to skip this \ud83e\udd37 ",
        "pr_file_module": null
      },
      {
        "comment_id": "2319242451",
        "repo_full_name": "nrwl/nx",
        "pr_number": 32557,
        "pr_file": "packages/nx/src/utils/provenance.ts",
        "discussion_id": "2319153503",
        "commented_code": "@@ -0,0 +1,95 @@\n+import { execFile } from 'child_process';\n+import { promisify } from 'util';\n+\n+export async function checkPackageHasProvenance(\n+  packageName: string,\n+  packageVersion: string\n+): Promise<{\n+  success: boolean;\n+  error?: string;\n+}> {\n+  // this is used for locally released versions without provenance\n+  // do not set this for other reasons or you might be exposed to security risks\n+  if (process.env.NX_MIGRATE_SKIP_PROVENANCE_CHECK) {\n+    return {\n+      success: true,\n+    };\n+  }\n+  const execFileAsync = promisify(execFile);\n+\n+  const npmViewResult = JSON.parse(\n+    (\n+      await execFileAsync(\n+        'npm',\n+        ['view', `${packageName}@${packageVersion}`, '--json'],\n+        {\n+          timeout: 20000,\n+        }\n+      )\n+    ).stdout.trim()\n+  );\n+\n+  const attURL = npmViewResult.dist?.attestations?.url;\n+\n+  if (!attURL) return { success: false, error: 'No attestation URL found' };\n+\n+  // refer to https://slsa.dev/spec/v1.1/provenance#schema for the shape of this object\n+  const attestations = (await (await fetch(attURL)).json()) as any;\n+\n+  const provenanceAttestation = attestations?.attestations?.find(\n+    (a) => a.predicateType === 'https://slsa.dev/provenance/v1'\n+  );\n+  if (!provenanceAttestation)\n+    return { success: false, error: 'No provenance attestation found' };\n+\n+  const dsseEnvelopePayload = JSON.parse(\n+    Buffer.from(\n+      provenanceAttestation.bundle.dsseEnvelope.payload,\n+      'base64'\n+    ).toString()\n+  );\n+\n+  const workflowParameters =\n+    dsseEnvelopePayload?.predicate?.buildDefinition?.externalParameters\n+      ?.workflow;\n+\n+  // verify that provenance was actually generated from the right publishing workflow\n+  if (workflowParameters?.repository !== 'https://github.com/nrwl/nx') {\n+    return { success: false, error: 'Repository does not match nrwl/nx' };\n+  }\n+  if (workflowParameters?.path !== '.github/workflows/publish.yml') {\n+    return {\n+      success: false,\n+      error: 'Publishing workflow does not match .github/workflows/publish.yml',",
        "comment_created_at": "2025-09-03T14:51:40+00:00",
        "comment_author": "MaxKless",
        "comment_body": "yes, I updated it to throw an error, it's cleaner.\r\nAlso added an instruction to check the package at npmjs.org.\r\n\r\nI don't know about the last bit, I would be very hesitant about adding an instruction to skip here as people don't really read error messages and if they don't know what provenance is, they might just ignore the warning and skip the check.",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "2266948453",
    "pr_number": 32252,
    "pr_file": "packages/js/src/executors/release-publish/release-publish.impl.ts",
    "created_at": "2025-08-11T14:26:25+00:00",
    "commented_code": "context: ExecutorContext\n ) {\n   const pm = detectPackageManager();\n+\n+  let isNpmInstalled = false;\n+  try {\n+    // If npm is installed, we should get a version string, otherwise an error will be thrown.\n+    isNpmInstalled =\n+      getPackageManagerVersion('npm', process.cwd(), true) !== '';\n+  } catch (e) {\n+    // Allow missing npm only when using bun (https://github.com/nrwl/nx/pull/32252#discussion_r2262481795)\n+    if (pm !== 'bun') {\n+      throw e;",
    "repo_full_name": "nrwl/nx",
    "discussion_comments": [
      {
        "comment_id": "2266948453",
        "repo_full_name": "nrwl/nx",
        "pr_number": 32252,
        "pr_file": "packages/js/src/executors/release-publish/release-publish.impl.ts",
        "discussion_id": "2266948453",
        "commented_code": "@@ -33,6 +34,19 @@ export default async function runExecutor(\n   context: ExecutorContext\n ) {\n   const pm = detectPackageManager();\n+\n+  let isNpmInstalled = false;\n+  try {\n+    // If npm is installed, we should get a version string, otherwise an error will be thrown.\n+    isNpmInstalled =\n+      getPackageManagerVersion('npm', process.cwd(), true) !== '';\n+  } catch (e) {\n+    // Allow missing npm only when using bun (https://github.com/nrwl/nx/pull/32252#discussion_r2262481795)\n+    if (pm !== 'bun') {\n+      throw e;",
        "comment_created_at": "2025-08-11T14:26:25+00:00",
        "comment_author": "JamesHenry",
        "comment_body": "I'd rather have this be a controlled user-facing message and handled error state please:\r\n\r\n```ts\r\nconsole.error(`npm was not found in the current environment. This is only supported when using \\`bun\\` as a package manager, but your detected package manager is \"${pm}\"`);\r\nreturn {\r\n  success: false,\r\n};\r\n```",
        "pr_file_module": null
      }
    ]
  }
]