[
  {
    "discussion_id": "2072570693",
    "pr_number": 16530,
    "pr_file": ".github/workflows/ci.yml",
    "created_at": "2025-05-04T09:42:15+00:00",
    "commented_code": "(github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v2.'))\n           ||\n           (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v3.'))\n-        run: ./scripts/ui_release.sh --check-package \"$(./scripts/get_module_version.sh ${{ github.ref_name }})\"\n+        run: ./scripts/ui_release.sh --check-package \"$(./scripts/get_module_version.sh ${GH_REF_NAME})\"\n+        env:\n+          GH_REF_NAME: ${{ github.ref_name }}",
    "repo_full_name": "prometheus/prometheus",
    "discussion_comments": [
      {
        "comment_id": "2072570693",
        "repo_full_name": "prometheus/prometheus",
        "pr_number": 16530,
        "pr_file": ".github/workflows/ci.yml",
        "discussion_id": "2072570693",
        "commented_code": "@@ -269,7 +301,9 @@ jobs:\n           (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v2.'))\n           ||\n           (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v3.'))\n-        run: ./scripts/ui_release.sh --check-package \"$(./scripts/get_module_version.sh ${{ github.ref_name }})\"\n+        run: ./scripts/ui_release.sh --check-package \"$(./scripts/get_module_version.sh ${GH_REF_NAME})\"\n+        env:\n+          GH_REF_NAME: ${{ github.ref_name }}",
        "comment_created_at": "2025-05-04T09:42:15+00:00",
        "comment_author": "aknuds1",
        "comment_body": "What difference does this change make?",
        "pr_file_module": null
      },
      {
        "comment_id": "2073709082",
        "repo_full_name": "prometheus/prometheus",
        "pr_number": 16530,
        "pr_file": ".github/workflows/ci.yml",
        "discussion_id": "2072570693",
        "commented_code": "@@ -269,7 +301,9 @@ jobs:\n           (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v2.'))\n           ||\n           (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v3.'))\n-        run: ./scripts/ui_release.sh --check-package \"$(./scripts/get_module_version.sh ${{ github.ref_name }})\"\n+        run: ./scripts/ui_release.sh --check-package \"$(./scripts/get_module_version.sh ${GH_REF_NAME})\"\n+        env:\n+          GH_REF_NAME: ${{ github.ref_name }}",
        "comment_created_at": "2025-05-05T15:53:42+00:00",
        "comment_author": "jharvey10",
        "comment_body": "This is an interesting one!\r\n\r\nContext:\r\n- https://woodruffw.github.io/zizmor/audits/#template-injection\r\n- https://securitylab.github.com/resources/github-actions-untrusted-input/\r\n\r\nBasically someone who can invoke this workflow against the prometheus repo could craft a ridiculous branch/ref name that results in arbitrary code execution because github template expansions happens _before_ workflow execution, and the result of the expansion gets dumped into the run command as plain text.\r\n\r\n\r\nMoving the expansion to an environment variable essentially causes the value to be interpreted as a normal shell variable, provided you use shell expansion `${...}` to actually make use of the variable in the `run: ` command instead of github workflow template expansion `${{ ... }}`.\r\n\r\nSince this workflow *isn't* using something like `pull_request_target` as one of its triggers (which would cause a fork's version of the workflow files to run _within the prometheus repo_), the impact is somewhat lower, since the attack would need to be carried out by someone with write access to the prometheus repo.",
        "pr_file_module": null
      }
    ]
  }
]