[
  {
    "discussion_id": "2440949904",
    "pr_number": 39794,
    "pr_file": "components/fonts/font_context.rs",
    "created_at": "2025-10-17T19:00:04+00:00",
    "commented_code": "RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n                 // TODO: Set policy_container from globalscope that contains the fontcontext\n                 .policy_container(Default::default())\n+                .origin(ImmutableOrigin::new(url.origin()))",
    "repo_full_name": "servo/servo",
    "discussion_comments": [
      {
        "comment_id": "2440949904",
        "repo_full_name": "servo/servo",
        "pr_number": 39794,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2440949904",
        "commented_code": "@@ -820,6 +820,7 @@ impl RemoteWebFontDownloader {\n             RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n                 // TODO: Set policy_container from globalscope that contains the fontcontext\n                 .policy_container(Default::default())\n+                .origin(ImmutableOrigin::new(url.origin()))",
        "comment_created_at": "2025-10-17T19:00:04+00:00",
        "comment_author": "jdm",
        "comment_body": "Please add a TODO comment about using the document's origin here. We really need to finish https://github.com/servo/servo/pull/37021.",
        "pr_file_module": null
      }
    ]
  },
  {
    "discussion_id": "2092555743",
    "pr_number": 37021,
    "pr_file": "components/fonts/font_context.rs",
    "created_at": "2025-05-16T08:08:34+00:00",
    "commented_code": "None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
    "repo_full_name": "servo/servo",
    "discussion_comments": [
      {
        "comment_id": "2092555743",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-16T08:08:34+00:00",
        "comment_author": "jdm",
        "comment_body": "Can you choose a test that's failing, then \r\n1. Try commenting out all of the new request builder additions in this section \r\n2. Verify the test passes\r\n3. Uncomment the new additions one by one and see when the test starts to fail?",
        "pr_file_module": null
      },
      {
        "comment_id": "2092807288",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-16T10:41:05+00:00",
        "comment_author": "uthmaniv",
        "comment_body": "Ok , thanks",
        "pr_file_module": null
      },
      {
        "comment_id": "2096407928",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-19T20:04:10+00:00",
        "comment_author": "uthmaniv",
        "comment_body": "How do I choose a failing test please? ",
        "pr_file_module": null
      },
      {
        "comment_id": "2096491090",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-19T21:08:07+00:00",
        "comment_author": "sebsebmc",
        "comment_body": "If you look at https://github.com/servo/servo/pull/37021#issuecomment-2885881823 under the \"stable unexpected results\". Most of those should be failing for the same reason so you can pick any and attempt the above steps to figure out whats going wrong. You can quickly run a single test with `./mach test-wpt [test-name-here]`",
        "pr_file_module": null
      },
      {
        "comment_id": "2096605848",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-19T23:29:01+00:00",
        "comment_author": "uthmaniv",
        "comment_body": "> If you look at [#37021 (comment)](https://github.com/servo/servo/pull/37021#issuecomment-2885881823) under the \"stable unexpected results\". Most of those should be failing for the same reason so you can pick any and attempt the above steps to figure out whats going wrong. You can quickly run a single test with `./mach test-wpt [test-name-here]`\r\n\r\nThat was helpful. Thanks",
        "pr_file_module": null
      },
      {
        "comment_id": "2096616248",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-19T23:45:22+00:00",
        "comment_author": "sebsebmc",
        "comment_body": "I think you also may need to set an origin for the request to be the origin of the containing document.",
        "pr_file_module": null
      },
      {
        "comment_id": "2097432300",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-20T09:05:44+00:00",
        "comment_author": "uthmaniv",
        "comment_body": "The test still fails after setting the origin for the request and commenting out the new additions, which is supposed to pass?",
        "pr_file_module": null
      },
      {
        "comment_id": "2097732748",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-20T11:38:05+00:00",
        "comment_author": "jdm",
        "comment_body": "Are you sure you compiled the build before running the test? When I build this branch and run `./mach test-wpt /_mozilla/css/inline_block_parent_padding_a.html`, I get a test failure. When I comment out all of the new request builder additions, the test passes. ",
        "pr_file_module": null
      },
      {
        "comment_id": "2097748257",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-20T11:46:52+00:00",
        "comment_author": "uthmaniv",
        "comment_body": "![image](https://github.com/user-attachments/assets/6e4097e5-1dd1-4103-be57-f6f3c1ea9309)\r\nYes I did, though I added the origin which was not there before, I am now trying to build it without the origin set if that might make a difference?\r\n",
        "pr_file_module": null
      },
      {
        "comment_id": "2097752650",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-20T11:49:21+00:00",
        "comment_author": "jdm",
        "comment_body": "Oh, this is fun: the problem is `.mode(RequestMode::CorsMode)`, because our tests load our custom ahem.css that loads a font from a local file source which is always cross-origin to the test file. I have a PR that should fix this.",
        "pr_file_module": null
      },
      {
        "comment_id": "2097758314",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-20T11:52:28+00:00",
        "comment_author": "jdm",
        "comment_body": "https://github.com/servo/servo/pull/37054",
        "pr_file_module": null
      },
      {
        "comment_id": "2098426160",
        "repo_full_name": "servo/servo",
        "pr_number": 37021,
        "pr_file": "components/fonts/font_context.rs",
        "discussion_id": "2092555743",
        "commented_code": "@@ -792,10 +820,20 @@ impl RemoteWebFontDownloader {\n             None => return,\n         };\n \n-        // FIXME: This shouldn't use NoReferrer, but the current documents url\n-        let request =\n-            RequestBuilder::new(state.webview_id, url.clone().into(), Referrer::NoReferrer)\n-                .destination(Destination::Font);\n+        let document_context = &state.document_context;\n+\n+        let request = RequestBuilder::new(\n+            state.webview_id,\n+            url.clone().into(),\n+            Referrer::ReferrerUrl(document_context.document_url.clone()),\n+        )\n+        .destination(Destination::Font)\n+        .mode(RequestMode::CorsMode)",
        "comment_created_at": "2025-05-20T16:36:51+00:00",
        "comment_author": "uthmaniv",
        "comment_body": "> #37054\r\n\r\nWaiting for it to get merged, it does not compile \r\n",
        "pr_file_module": null
      }
    ]
  }
]